---
phase: 08-security-and-fixes
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/tenant-dashboard/src/pages/invoices/InvoicesList.jsx
  - frontend/tenant-dashboard/src/App.jsx
  - frontend/tenant-dashboard/.env.example
autonomous: true

must_haves:
  truths:
    - "Invoice creation modal shows quotes in the dropdown with customer name, destination, and amount"
    - "Password reset redirects to correct port (5173) instead of 3000"
    - "User can select a quote from the dropdown to create an invoice"
  artifacts:
    - path: "frontend/tenant-dashboard/src/pages/invoices/InvoicesList.jsx"
      provides: "Working quote dropdown in invoice creation modal"
      contains: "quotes\\.length"
    - path: "frontend/tenant-dashboard/.env.example"
      provides: "Documentation of required environment variables"
      contains: "VITE_APP_URL"
  key_links:
    - from: "InvoicesList.jsx"
      to: "quotesApi.list"
      via: "loadData function"
      pattern: "setQuotes.*quotesRes"
---

<objective>
Fix invoice quote selection dropdown and configure password reset redirect URL.

Purpose: The invoice creation modal's "Select Quote" dropdown shows no quotes even though quotes exist. Additionally, password reset emails from Supabase redirect to localhost:3000 but the frontend runs on port 5173.

Output: Working quote dropdown for invoice creation and correct password reset redirects.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@frontend/tenant-dashboard/src/pages/invoices/InvoicesList.jsx
@frontend/tenant-dashboard/src/pages/ResetPassword.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Debug and fix quote dropdown in invoice modal</name>
  <files>frontend/tenant-dashboard/src/pages/invoices/InvoicesList.jsx</files>
  <action>
The issue is in the CreateInvoiceModal component. Looking at the code:

1. Line 1067-1069: `setQuotes(quotesRes.data?.data || [])` - This extracts quotes from API response
2. Line 778-785: The dropdown renders quotes correctly IF quotes array has items

The bug is likely that quotes are being filtered or the API response structure changed.

Add debugging and fix potential issues:

1. Add console logging in loadData to diagnose (around line 1063-1075):
```javascript
const loadData = async () => {
  try {
    setLoading(true);
    const [invoicesRes, quotesRes] = await Promise.all([
      invoicesApi.list({ status: statusFilter || undefined, limit: 50 }),
      quotesApi.list({ limit: 100 }),  // Increase limit to ensure we get quotes
    ]);

    console.log('[InvoicesList] Quotes API response:', quotesRes);

    const invoiceData = invoicesRes.data?.data || invoicesRes.data || [];
    setInvoices(Array.isArray(invoiceData) ? invoiceData : []);

    // Handle both response structures: { data: [...] } or direct array
    const quotesData = quotesRes.data?.data || quotesRes.data || [];
    console.log('[InvoicesList] Extracted quotes:', quotesData.length);
    setQuotes(Array.isArray(quotesData) ? quotesData : []);
    ...
```

2. In the CreateInvoiceModal dropdown (around line 778-785), add a fallback message:
```jsx
<div>
  <label className="block text-sm font-medium text-gray-700 mb-1">Select Quote *</label>
  <select value={selectedQuoteId} onChange={(e) => setSelectedQuoteId(e.target.value)} className="input">
    <option value="">
      {quotes.length === 0 ? 'No quotes available - create a quote first' : 'Choose a quote...'}
    </option>
    {quotes.map((quote) => (
      <option key={quote.quote_id} value={quote.quote_id}>
        {quote.customer_name} - {quote.destination} (R {(quote.total_price || 0).toLocaleString()})
      </option>
    ))}
  </select>
  {quotes.length === 0 && (
    <p className="text-xs text-amber-600 mt-1">
      Generate a quote first, then you can convert it to an invoice.
    </p>
  )}
</div>
```

3. Filter quotes to only show those that can be converted (status = 'sent' or 'approved'):
```javascript
// After setting quotes, filter to convertible ones for the modal
const convertibleQuotes = quotesData.filter(q =>
  ['sent', 'approved', 'draft'].includes(q.status)
);
setQuotes(convertibleQuotes);
```

This ensures only valid quotes appear in the dropdown.
  </action>
  <verify>
Run: `grep -n "quotes.length" frontend/tenant-dashboard/src/pages/invoices/InvoicesList.jsx` - should show length check
Run: `grep -n "No quotes available" frontend/tenant-dashboard/src/pages/invoices/InvoicesList.jsx` - should show fallback message
  </verify>
  <done>
Quote dropdown shows available quotes with helpful message when none exist. Debug logging added to diagnose any issues.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure password reset redirect URL</name>
  <files>frontend/tenant-dashboard/.env.example, frontend/tenant-dashboard/src/App.jsx</files>
  <action>
The password reset flow works as follows:
1. User requests reset via /api/v1/auth/password/reset
2. Supabase sends email with reset link pointing to configured Site URL
3. User clicks link and lands on frontend ResetPassword page
4. Frontend calls /api/v1/auth/password/update with token

The issue is Supabase's Site URL configuration. This needs to be set in:
1. Supabase Dashboard > Authentication > URL Configuration > Site URL
2. Also needs to be in the redirect_to parameter for password reset

**Frontend changes:**

1. Create/update `.env.example`:
```env
# API Configuration
VITE_API_URL=http://localhost:8000

# App Configuration
VITE_APP_URL=http://localhost:5173

# Client Configuration (optional - defaults to africastay)
VITE_CLIENT_ID=africastay
```

2. Update App.jsx to add the /reset-password route if not already present:
```jsx
// Check if ResetPassword route exists, add if needed
// Should be: <Route path="/reset-password" element={<ResetPassword />} />
```

3. Document the Supabase configuration requirement in .env.example:
```env
# IMPORTANT: For password reset to work, configure in Supabase Dashboard:
# Authentication > URL Configuration > Site URL: http://localhost:5173
# Authentication > URL Configuration > Redirect URLs: http://localhost:5173/*
#
# For production, update these URLs to your production domain.
```

4. The ResetPassword.jsx component already handles the token from URL params correctly.
   No changes needed there.

**Backend change note:**
The auth_service.py `request_password_reset` method uses Supabase's built-in email.
The redirect URL is controlled by Supabase Dashboard configuration, not code.
Add a comment in the method explaining this:

```python
async def request_password_reset(self, email: str) -> Tuple[bool, Dict[str, Any]]:
    """
    Send password reset email.

    NOTE: The redirect URL in the reset email is configured in Supabase Dashboard:
    Authentication > URL Configuration > Site URL
    Set this to your frontend URL (e.g., http://localhost:5173 for development)
    """
```
  </action>
  <verify>
Run: `cat frontend/tenant-dashboard/.env.example` - should show VITE_APP_URL
Run: `grep -n "reset-password" frontend/tenant-dashboard/src/App.jsx` - should show route
  </verify>
  <done>
Password reset URL configuration documented. .env.example created with proper configuration notes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add note about Supabase URL configuration</name>
  <files>src/services/auth_service.py</files>
  <action>
Add documentation in the request_password_reset method explaining how to configure the redirect URL:

Update the docstring around line 395-411:
```python
async def request_password_reset(self, email: str) -> Tuple[bool, Dict[str, Any]]:
    """
    Send password reset email via Supabase Auth.

    The password reset link in the email points to the Site URL configured in Supabase.

    CONFIGURATION REQUIRED:
    1. Supabase Dashboard > Authentication > URL Configuration
    2. Set "Site URL" to your frontend URL (e.g., http://localhost:5173)
    3. Add your frontend URL to "Redirect URLs" (e.g., http://localhost:5173/*)

    The reset link format: {Site URL}/reset-password?token={token}&type=recovery

    Args:
        email: User's email address

    Returns:
        Tuple of (success, message/error)
    """
```

This makes it clear to developers where to configure the redirect URL.
  </action>
  <verify>
Run: `grep -A10 "request_password_reset" src/services/auth_service.py | head -15` - should show Supabase configuration notes
  </verify>
  <done>
Password reset documentation added explaining Supabase URL configuration requirements.
  </done>
</task>

</tasks>

<verification>
1. Quote dropdown has fallback: `grep "No quotes available" frontend/tenant-dashboard/src/pages/invoices/InvoicesList.jsx`
2. .env.example exists: `cat frontend/tenant-dashboard/.env.example`
3. Reset password route exists: `grep "reset-password" frontend/tenant-dashboard/src/App.jsx`
4. Auth service documented: `grep -A5 "CONFIGURATION REQUIRED" src/services/auth_service.py`
5. Frontend builds: `cd frontend/tenant-dashboard && npm run build` (if npm available)
</verification>

<success_criteria>
- Invoice creation modal shows quotes in dropdown (or helpful message if none)
- User can select a quote and create an invoice from it
- .env.example documents required environment variables
- Supabase URL configuration is documented in auth_service.py
- Password reset flow works when Supabase is properly configured
</success_criteria>

<output>
After completion, create `.planning/phases/08-security-and-fixes/08-03-SUMMARY.md`
</output>
