---
phase: 08-security-and-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/auth_routes.py
  - src/api/admin_routes.py
  - requirements.txt
autonomous: true

must_haves:
  truths:
    - "Login endpoint is rate limited to prevent brute force attacks"
    - "Password reset endpoint is rate limited"
    - "Admin endpoints require valid token (no dev mode bypass)"
  artifacts:
    - path: "src/api/auth_routes.py"
      provides: "Rate limiting on login and password endpoints"
      contains: "slowapi|RateLimiter"
    - path: "src/api/admin_routes.py"
      provides: "Strict admin token validation"
      contains: "raise HTTPException.*401"
  key_links:
    - from: "src/api/auth_routes.py"
      to: "slowapi limiter"
      via: "rate limit decorator"
      pattern: "@limiter\\.limit"
---

<objective>
Add rate limiting to authentication endpoints and remove unsafe admin token bypass.

Purpose: Prevent brute force password attacks and ensure admin endpoints are always protected. Currently there is no rate limiting on login, and admin routes allow unauthenticated access if ADMIN_API_TOKEN is not configured.

Output: Rate-limited auth endpoints and strictly protected admin routes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/api/auth_routes.py
@src/api/admin_routes.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rate limiting to auth endpoints</name>
  <files>src/api/auth_routes.py, requirements.txt</files>
  <action>
1. First, add slowapi to requirements.txt if not already present:
   `slowapi>=0.1.9`

2. In auth_routes.py, add imports at the top:
```python
from slowapi import Limiter
from slowapi.util import get_remote_address
from slowapi.errors import RateLimitExceeded
from fastapi import Request

# Initialize rate limiter
limiter = Limiter(key_func=get_remote_address)
```

3. Add rate limit decorators to sensitive endpoints:

For `/login` endpoint (line ~109):
```python
@auth_router.post("/login", response_model=LoginResponse)
@limiter.limit("5/minute")  # 5 attempts per minute per IP
async def login(
    request: Request,  # Add this parameter
    login_request: LoginRequest,  # Rename from 'request' to avoid conflict
    ...
```

For `/password/reset` endpoint (line ~233):
```python
@auth_router.post("/password/reset")
@limiter.limit("3/minute")  # 3 reset requests per minute
async def request_password_reset(
    request: Request,  # Add for rate limiter
    reset_request: PasswordResetRequest,  # Rename
    ...
```

For `/password/update` endpoint (line ~251):
```python
@auth_router.post("/password/update")
@limiter.limit("5/minute")  # 5 attempts per minute
async def update_password_with_token(
    request: Request,
    update_request: PasswordUpdateWithTokenRequest,
    ...
```

4. Export the limiter for app integration:
```python
# At the bottom of the file
def get_auth_limiter():
    """Get the rate limiter for app state registration"""
    return limiter
```

Note: The main.py will need to register the limiter with the app state for it to work.
Add this note as a comment in the file for future reference.
  </action>
  <verify>
Run: `grep -n "limiter.limit" src/api/auth_routes.py` - should show rate limit decorators
Run: `grep "slowapi" requirements.txt` - should show slowapi dependency
  </verify>
  <done>
Rate limiting added to login (5/min), password reset (3/min), and password update (5/min) endpoints.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove unsafe admin token bypass</name>
  <files>src/api/admin_routes.py</files>
  <action>
Modify the `verify_admin_token` function (around line 70-82) to ALWAYS require a valid token:

Replace the current implementation:
```python
def verify_admin_token(x_admin_token: str = Header(None, alias="X-Admin-Token")) -> bool:
    """Verify admin authentication token"""
    admin_token = os.getenv("ADMIN_API_TOKEN")

    if not admin_token:
        # If no admin token configured, allow access (dev mode)
        logger.warning("No ADMIN_API_TOKEN configured - admin endpoints are unprotected")
        return True

    if x_admin_token != admin_token:
        raise HTTPException(status_code=401, detail="Invalid admin token")

    return True
```

With this secure version:
```python
def verify_admin_token(x_admin_token: str = Header(None, alias="X-Admin-Token")) -> bool:
    """
    Verify admin authentication token.

    SECURITY: Always requires a valid token. If ADMIN_API_TOKEN is not configured,
    all admin requests are rejected. This prevents accidental exposure in production.
    """
    admin_token = os.getenv("ADMIN_API_TOKEN")

    if not admin_token:
        logger.error(
            "ADMIN_API_TOKEN not configured - admin endpoints are disabled. "
            "Set ADMIN_API_TOKEN environment variable to enable admin access."
        )
        raise HTTPException(
            status_code=503,
            detail="Admin endpoints not configured. Contact system administrator."
        )

    if not x_admin_token:
        raise HTTPException(status_code=401, detail="X-Admin-Token header required")

    if x_admin_token != admin_token:
        logger.warning(f"Invalid admin token attempt from request")
        raise HTTPException(status_code=401, detail="Invalid admin token")

    return True
```

This ensures:
1. Admin endpoints are NEVER unprotected
2. Missing ADMIN_API_TOKEN returns 503 (service unavailable) with clear message
3. Missing X-Admin-Token header returns 401
4. Invalid token returns 401 with logging
  </action>
  <verify>
Run: `grep -A5 "if not admin_token:" src/api/admin_routes.py` - should show HTTPException not "return True"
  </verify>
  <done>
Admin token bypass removed. All admin endpoints now require valid ADMIN_API_TOKEN configuration and valid X-Admin-Token header.
  </done>
</task>

<task type="auto">
  <name>Task 3: Register rate limiter in main.py</name>
  <files>main.py</files>
  <action>
Add rate limiter registration in main.py:

1. Add import at the top:
```python
from slowapi import _rate_limit_exceeded_handler
from slowapi.errors import RateLimitExceeded
```

2. After app creation and before including routers, add:
```python
# Rate limiting setup
from src.api.auth_routes import get_auth_limiter
limiter = get_auth_limiter()
app.state.limiter = limiter
app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)
```

This registers the rate limiter with FastAPI so the decorators work correctly.
  </action>
  <verify>
Run: `grep "state.limiter" main.py` - should show limiter registration
Run: `grep "RateLimitExceeded" main.py` - should show exception handler
  </verify>
  <done>
Rate limiter properly integrated with FastAPI application.
  </done>
</task>

</tasks>

<verification>
1. Rate limiting on login: `grep -B2 "async def login" src/api/auth_routes.py | grep limiter`
2. Admin bypass removed: `grep -A10 "if not admin_token:" src/api/admin_routes.py | grep "HTTPException"`
3. slowapi in requirements: `grep "slowapi" requirements.txt`
4. Limiter registered in main: `grep "state.limiter" main.py`
5. No syntax errors: `python -c "from src.api.auth_routes import auth_router; print('OK')"`
</verification>

<success_criteria>
- Login endpoint limited to 5 requests/minute per IP
- Password reset limited to 3 requests/minute per IP
- Admin endpoints return 503 if ADMIN_API_TOKEN not configured
- Admin endpoints return 401 if X-Admin-Token header missing or invalid
</success_criteria>

<output>
After completion, create `.planning/phases/08-security-and-fixes/08-02-SUMMARY.md`
</output>
