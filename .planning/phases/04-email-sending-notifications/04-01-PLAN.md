---
phase: 04-email-sending-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/routes.py
  - src/api/notifications_routes.py
  - src/agents/quote_agent.py
autonomous: true

must_haves:
  truths:
    - "Consultant can approve a draft quote via API endpoint"
    - "Approved quote is emailed to customer via tenant's SendGrid subuser"
    - "Quote email contains PDF attachment"
    - "Quote status changes from 'draft' to 'sent'"
    - "Consultant receives notification confirming quote was sent"
  artifacts:
    - path: "src/api/routes.py"
      provides: "POST /api/v1/quotes/{quote_id}/send endpoint"
      contains: "send_quote"
    - path: "src/api/notifications_routes.py"
      provides: "notify_quote_sent method"
      contains: "def notify_quote_sent"
    - path: "src/agents/quote_agent.py"
      provides: "send_draft_quote method"
      contains: "def send_draft_quote"
  key_links:
    - from: "src/api/routes.py"
      to: "src/agents/quote_agent.py"
      via: "send_draft_quote call"
      pattern: "quote_agent\\.send_draft_quote"
    - from: "src/agents/quote_agent.py"
      to: "src/utils/email_sender.py"
      via: "send_quote_email call"
      pattern: "email_sender\\.send_quote_email"
    - from: "src/agents/quote_agent.py"
      to: "src/api/notifications_routes.py"
      via: "notify_quote_sent call"
      pattern: "notify_quote_sent"
---

<objective>
Implement quote approval and sending workflow that allows consultants to review draft quotes, approve them, and send to customers via the tenant's SendGrid subuser with PDF attachment.

Purpose: Complete the inbound email -> quote pipeline by enabling consultants to send reviewed quotes to customers.

Output:
- API endpoint POST /api/v1/quotes/{quote_id}/send
- QuoteAgent.send_draft_quote() method
- NotificationService.notify_quote_sent() method
- Quote status lifecycle: draft -> sent
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-quote-generation-pipeline/03-01-SUMMARY.md

# Key implementation files
@src/agents/quote_agent.py
@src/utils/email_sender.py
@src/api/notifications_routes.py
@src/api/routes.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add send_draft_quote method to QuoteAgent</name>
  <files>src/agents/quote_agent.py</files>
  <action>
Add a new method `send_draft_quote(quote_id: str) -> Dict[str, Any]` to QuoteAgent that:

1. Retrieves the quote by ID using existing `get_quote()` method
2. Validates quote exists and status is 'draft'
3. Regenerates or retrieves PDF (quote already has PDF generated per Phase 3)
4. Sends email using `self.email_sender.send_quote_email()` with:
   - customer_email from quote.customer_email
   - customer_name from quote.customer_name
   - quote_pdf_data (regenerate PDF using self.pdf_generator)
   - destination from quote.destination
   - quote_id from quote.quote_id
5. Updates quote status to 'sent' using existing `update_quote_status()`
6. Schedules follow-up call if customer has phone number (use existing `_schedule_follow_up_call()`)
7. Creates notification for "quote sent" using NotificationService
8. Returns success/failure with quote_id and sent_at timestamp

Important implementation notes:
- Use existing EmailSender (already configured with tenant's SendGrid subuser API key)
- Regenerate PDF using self.pdf_generator.generate_quote_pdf() since quote.hotels is stored
- Handle errors gracefully - if email fails, don't update status to 'sent'
- Log diagnostic info for troubleshooting

Method signature:
```python
def send_draft_quote(self, quote_id: str) -> Dict[str, Any]:
    """
    Send a draft quote to the customer.

    Args:
        quote_id: The quote ID to send

    Returns:
        Dict with success, quote_id, sent_at, email_sent, error (if any)
    """
```
  </action>
  <verify>
Read src/agents/quote_agent.py and verify:
- send_draft_quote method exists
- Method calls email_sender.send_quote_email
- Method calls update_quote_status with 'sent'
- Method creates notification via NotificationService
  </verify>
  <done>send_draft_quote method implemented with email sending, status update, and notification creation</done>
</task>

<task type="auto">
  <name>Task 2: Add notify_quote_sent to NotificationService</name>
  <files>src/api/notifications_routes.py</files>
  <action>
Add a new method `notify_quote_sent()` to the NotificationService class:

```python
def notify_quote_sent(
    self,
    customer_name: str,
    customer_email: str,
    destination: str,
    quote_id: str
):
    """Notify consultant that quote was sent successfully"""
    self.notify_all_users(
        type='system',  # Use 'system' type since 'quote_sent' not in allowed types
        title='Quote sent',
        message=f'Quote for {customer_name} ({destination}) sent to {customer_email}',
        entity_type='quote',
        entity_id=quote_id
    )
```

Place this method after the existing `notify_quote_request()` method (around line 614).

Note: Using 'system' type because the notification type CHECK constraint in the database only allows specific types ('quote_request', 'email_received', 'invoice_paid', etc.). The 'system' type is already allowed and appropriate for this purpose.
  </action>
  <verify>
Grep for "notify_quote_sent" in src/api/notifications_routes.py to confirm method exists
  </verify>
  <done>NotificationService has notify_quote_sent method that creates dashboard notification</done>
</task>

<task type="auto">
  <name>Task 3: Add POST /api/v1/quotes/{quote_id}/send endpoint</name>
  <files>src/api/routes.py</files>
  <action>
Add a new endpoint to routes.py for sending draft quotes:

```python
@router.post("/quotes/{quote_id}/send")
async def send_quote(
    quote_id: str,
    config: ClientConfig = Depends(get_client_config),
    user_id: str = Depends(get_current_user_id)  # Ensures authenticated
):
    """
    Send a draft quote to the customer.

    Requires authentication. Only draft quotes can be sent.

    The quote will be:
    1. Retrieved from database
    2. PDF regenerated
    3. Email sent to customer via tenant's SendGrid subuser
    4. Status updated to 'sent'
    5. Notification created for consultant
    """
    try:
        from src.agents.quote_agent import QuoteAgent

        quote_agent = QuoteAgent(config)
        result = quote_agent.send_draft_quote(quote_id)

        if result.get('success'):
            return {
                'success': True,
                'quote_id': quote_id,
                'status': 'sent',
                'sent_at': result.get('sent_at'),
                'message': f"Quote sent to {result.get('customer_email')}"
            }
        else:
            raise HTTPException(
                status_code=400,
                detail=result.get('error', 'Failed to send quote')
            )

    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"Error sending quote {quote_id}: {e}")
        raise HTTPException(status_code=500, detail=str(e))
```

Important:
- Import HTTPException from fastapi if not already imported
- This endpoint requires authentication (get_current_user_id dependency)
- Uses existing get_client_config dependency for tenant context
- Place near other quote-related endpoints in routes.py
  </action>
  <verify>
Grep for "send_quote" in src/api/routes.py to confirm endpoint exists
  </verify>
  <done>POST /api/v1/quotes/{quote_id}/send endpoint exists and calls QuoteAgent.send_draft_quote</done>
</task>

</tasks>

<verification>
After all tasks complete, verify the full workflow:

1. **Method exists:** `grep -n "send_draft_quote" src/agents/quote_agent.py`
2. **Notification method exists:** `grep -n "notify_quote_sent" src/api/notifications_routes.py`
3. **Endpoint exists:** `grep -n "send_quote" src/api/routes.py`
4. **Email sending wired:** `grep -n "send_quote_email" src/agents/quote_agent.py`
5. **Status update wired:** `grep -n "update_quote_status.*sent" src/agents/quote_agent.py`
6. **Notification wired:** `grep -n "notify_quote_sent" src/agents/quote_agent.py`
</verification>

<success_criteria>
1. POST /api/v1/quotes/{quote_id}/send endpoint exists
2. QuoteAgent.send_draft_quote() sends email via tenant SendGrid
3. Email includes PDF attachment (via send_quote_email)
4. Quote status updates from 'draft' to 'sent'
5. Notification created for consultants
6. No syntax errors (python -m py_compile passes)
</success_criteria>

<output>
After completion, create `.planning/phases/04-email-sending-notifications/04-01-SUMMARY.md` using the summary template.
</output>
