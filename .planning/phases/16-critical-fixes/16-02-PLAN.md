---
phase: 16-critical-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/admin_routes.py
  - tests/test_admin_routes.py
autonomous: true

must_haves:
  truths:
    - "Admin token comparison is constant-time regardless of input length"
    - "Timing attack cannot determine correct token characters"
    - "Invalid tokens still rejected with 401"
  artifacts:
    - path: "src/api/admin_routes.py"
      provides: "Constant-time token comparison using hmac.compare_digest"
      contains: "hmac.compare_digest"
    - path: "tests/test_admin_routes.py"
      provides: "Tests verifying timing-safe comparison"
      contains: "test_admin_token_timing"
  key_links:
    - from: "src/api/admin_routes.py"
      to: "hmac.compare_digest"
      via: "import and usage in verify_admin_token"
      pattern: "compare_digest.*x_admin_token.*admin_token"
---

<objective>
Fix timing attack vulnerability in admin token verification.

Purpose: Prevent attackers from determining the correct admin token character-by-character through timing analysis of authentication responses.

Output: Constant-time token comparison using Python's `hmac.compare_digest()`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/PRODUCTION-AUDIT.md
@src/api/admin_routes.py (lines 71-97)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace string comparison with hmac.compare_digest</name>
  <files>src/api/admin_routes.py</files>
  <action>
Fix the timing attack vulnerability at line 93:

1. Add hmac import at the top of the file (near other imports):
   ```python
   import hmac
   ```

2. Replace the direct string comparison (line 93):
   ```python
   # BEFORE (vulnerable to timing attack):
   if x_admin_token != admin_token:

   # AFTER (constant-time comparison):
   if not hmac.compare_digest(x_admin_token.encode('utf-8'), admin_token.encode('utf-8')):
   ```

3. The full `verify_admin_token` function should now look like:
   ```python
   def verify_admin_token(x_admin_token: str = Header(None, alias="X-Admin-Token")) -> bool:
       """
       Verify admin authentication token.

       SECURITY: Always requires a valid token. If ADMIN_API_TOKEN is not configured,
       all admin requests are rejected. This prevents accidental exposure in production.

       Uses constant-time comparison to prevent timing attacks.
       """
       admin_token = os.getenv("ADMIN_API_TOKEN")

       if not admin_token:
           logger.error(
               "ADMIN_API_TOKEN not configured - admin endpoints are disabled. "
               "Set ADMIN_API_TOKEN environment variable to enable admin access."
           )
           raise HTTPException(
               status_code=503,
               detail="Admin endpoints not configured. Contact system administrator."
           )

       if not x_admin_token:
           raise HTTPException(status_code=401, detail="X-Admin-Token header required")

       # Use constant-time comparison to prevent timing attacks
       if not hmac.compare_digest(x_admin_token.encode('utf-8'), admin_token.encode('utf-8')):
           logger.warning(f"Invalid admin token attempt from request")
           raise HTTPException(status_code=401, detail="Invalid admin token")

       return True
   ```

WHY hmac.compare_digest:
- Standard `!=` operator short-circuits on first mismatched character
- Attacker can measure response time to guess characters one-by-one
- `hmac.compare_digest()` always compares all bytes, taking constant time
- This is the Python standard library's recommended approach (PEP 466)
  </action>
  <verify>
Run: `python -c "from src.api.admin_routes import verify_admin_token; print('Import successful')"` should pass.
  </verify>
  <done>Admin token comparison uses hmac.compare_digest for constant-time security.</done>
</task>

<task type="auto">
  <name>Task 2: Add tests verifying timing-safe behavior</name>
  <files>tests/test_admin_routes.py</files>
  <action>
Add tests to verify the timing-safe comparison is in place. First, read the existing test file to understand its structure, then add these tests:

1. Add import for hmac at the top if not present:
   ```python
   import hmac
   ```

2. Add a new test class or add to existing tests:
   ```python
   class TestAdminTokenTimingSafety:
       """Tests for timing-safe admin token verification"""

       def test_admin_token_uses_constant_time_comparison(self):
           """Verify that hmac.compare_digest is used for token comparison"""
           import inspect
           from src.api.admin_routes import verify_admin_token

           # Get the source code of the function
           source = inspect.getsource(verify_admin_token)

           # Verify it uses hmac.compare_digest
           assert 'hmac.compare_digest' in source, \
               "verify_admin_token must use hmac.compare_digest for constant-time comparison"

       def test_admin_token_rejects_wrong_token_with_401(self):
           """Verify wrong tokens are still rejected"""
           import os
           from unittest.mock import patch
           from fastapi import HTTPException
           import pytest
           from src.api.admin_routes import verify_admin_token

           with patch.dict(os.environ, {'ADMIN_API_TOKEN': 'correct-secret-token'}):
               with pytest.raises(HTTPException) as exc_info:
                   verify_admin_token('wrong-token')

               assert exc_info.value.status_code == 401
               assert 'Invalid admin token' in exc_info.value.detail

       def test_admin_token_accepts_correct_token(self):
           """Verify correct tokens are accepted"""
           import os
           from unittest.mock import patch
           from src.api.admin_routes import verify_admin_token

           with patch.dict(os.environ, {'ADMIN_API_TOKEN': 'correct-secret-token'}):
               result = verify_admin_token('correct-secret-token')
               assert result is True

       def test_admin_token_handles_unicode(self):
           """Verify token comparison works with unicode characters"""
           import os
           from unittest.mock import patch
           from src.api.admin_routes import verify_admin_token

           unicode_token = 'secret-token-with-unicode-'

           with patch.dict(os.environ, {'ADMIN_API_TOKEN': unicode_token}):
               result = verify_admin_token(unicode_token)
               assert result is True
   ```

NOTE: If the test file already has similar tests, integrate these into the existing structure rather than duplicating.
  </action>
  <verify>
Run: `pytest tests/test_admin_routes.py -v -k "timing or constant_time or unicode"` should pass.
  </verify>
  <done>Tests verify that hmac.compare_digest is used and tokens are properly validated.</done>
</task>

</tasks>

<verification>
1. Existing admin route tests pass: `pytest tests/test_admin_routes.py -v`
2. Source code contains hmac.compare_digest: `grep -n "hmac.compare_digest" src/api/admin_routes.py`
3. No direct string comparison for tokens: Verify `x_admin_token != admin_token` is NOT in the code
</verification>

<success_criteria>
- `hmac` module is imported in admin_routes.py
- `hmac.compare_digest()` used for token comparison
- No direct `!=` or `==` comparison of admin tokens
- Existing admin endpoint tests still pass
- New timing safety tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/16-critical-fixes/16-02-SUMMARY.md`
</output>
