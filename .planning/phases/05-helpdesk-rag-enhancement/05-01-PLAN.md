---
phase: 05-helpdesk-rag-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/faiss_helpdesk_service.py
  - src/api/helpdesk_routes.py
autonomous: true

must_haves:
  truths:
    - "Search returns 5-8 documents instead of default 5"
    - "Results include relevance scoring for filtering"
    - "Low-relevance results can be filtered out"
  artifacts:
    - path: "src/services/faiss_helpdesk_service.py"
      provides: "search_with_context method returning 8 docs"
      contains: "def search_with_context"
    - path: "src/api/helpdesk_routes.py"
      provides: "search_knowledge_base uses top_k=8"
      contains: "top_k=8"
  key_links:
    - from: "src/api/helpdesk_routes.py"
      to: "src/services/faiss_helpdesk_service.py"
      via: "search_with_context call"
      pattern: "search_with_context"
---

<objective>
Enhance FAISS search to return more context for RAG synthesis

Purpose: More documents = better context for LLM synthesis. Currently returns 5, need 5-8 with relevance filtering.

Output: Enhanced search returning 8 documents with relevance scores for quality filtering.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/services/faiss_helpdesk_service.py
@src/api/helpdesk_routes.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add search_with_context method to FAISS service</name>
  <files>src/services/faiss_helpdesk_service.py</files>
  <action>
Add a new method `search_with_context()` to FAISSHelpdeskService class:

```python
def search_with_context(self, query: str, top_k: int = 8, min_score: float = 0.3) -> List[Dict[str, Any]]:
    """
    Search for documents with more context for RAG synthesis.

    Args:
        query: The search query
        top_k: Number of results to return (default 8 for better RAG context)
        min_score: Minimum relevance score (0-1, filter out poor matches)

    Returns:
        List of dicts with 'content', 'score', 'source', filtered by min_score
    """
```

Implementation:
1. Call existing search(query, top_k)
2. Filter results where score >= min_score
3. If fewer than 3 results after filtering, return top 3 regardless of score (ensure some context)
4. Log count before and after filtering

Keep existing search() method unchanged for backwards compatibility.
  </action>
  <verify>
Add test at bottom of file:
```python
if __name__ == "__main__":
    service = FAISSHelpdeskService()
    if service.initialize():
        results = service.search_with_context("Maldives hotels with pool", top_k=8, min_score=0.3)
        print(f"Found {len(results)} relevant documents")
        for r in results[:3]:
            print(f"  Score: {r['score']:.3f} - {r['content'][:100]}...")
```
Run: `python src/services/faiss_helpdesk_service.py`
  </verify>
  <done>search_with_context() returns 5-8 filtered documents with relevance scores</done>
</task>

<task type="auto">
  <name>Task 2: Update helpdesk routes to use enhanced search</name>
  <files>src/api/helpdesk_routes.py</files>
  <action>
Update `search_shared_faiss_index()` function (around line 197):

1. Change from calling `service.search(query, top_k=top_k)` to `service.search_with_context(query, top_k=8, min_score=0.3)`
2. Update the function signature to remove top_k parameter (fixed at 8 now)
3. Update callers - search_knowledge_base() should not pass top_k

Update `search_knowledge_base()` function (around line 218):
1. Remove top_k parameter from shared_results call
2. Keep per-tenant fallback as-is (it has its own logic)

This ensures:
- Shared FAISS always returns 5-8 relevant documents
- Low-quality matches filtered out
- More context available for upcoming LLM synthesis (Plan 05-02)
  </action>
  <verify>
curl http://localhost:8000/api/v1/helpdesk/test-search?q=Zanzibar+beach+hotels

Expected: results_count between 5-8, all with reasonable scores
  </verify>
  <done>Helpdesk search returns 5-8 relevant documents for RAG context</done>
</task>

</tasks>

<verification>
1. `python src/services/faiss_helpdesk_service.py` - test script runs without error
2. Backend starts: `python main.py` - no import errors
3. Search returns more context: `/api/v1/helpdesk/test-search?q=Maldives` returns 5-8 results
4. Low-quality filtering works: results have scores >= 0.3 (or minimum 3 results)
</verification>

<success_criteria>
- search_with_context() method exists and returns 5-8 documents
- Results filtered by min_score with fallback to ensure minimum context
- No breaking changes to existing search() method
- Response time still < 3 seconds
</success_criteria>

<output>
After completion, create `.planning/phases/05-helpdesk-rag-enhancement/05-01-SUMMARY.md`
</output>
