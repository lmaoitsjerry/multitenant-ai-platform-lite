---
phase: 01-diagnostics-logging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/webhooks/email_webhook.py
  - .planning/phases/01-diagnostics-logging/01-DIAGNOSTICS.md
autonomous: true

must_haves:
  truths:
    - "Webhook endpoint /webhooks/email/inbound is registered and accessible"
    - "SendGrid Inbound Parse configuration is documented with current state"
    - "Webhook has comprehensive logging showing each step and failure point"
    - "Current failure point is identified with evidence from logs or code"
  artifacts:
    - path: "src/webhooks/email_webhook.py"
      provides: "Enhanced email webhook with diagnostic logging"
      contains: "DIAGNOSTIC_ID"
    - path: ".planning/phases/01-diagnostics-logging/01-DIAGNOSTICS.md"
      provides: "Documentation of current state and findings"
      contains: "## Current Failure Point"
  key_links:
    - from: "src/webhooks/email_webhook.py"
      to: "config.loader.get_config"
      via: "tenant resolution"
      pattern: "get_config\\(.*\\)"
    - from: "src/webhooks/email_webhook.py"
      to: "src/agents/universal_email_parser"
      via: "email parsing import"
      pattern: "from src\\.agents\\.universal_email_parser"
---

<objective>
Diagnose the inbound email pipeline and add comprehensive logging to identify why emails are not generating quotes.

Purpose: The inbound email auto-quote pipeline is broken. Before fixing it, we need to understand WHERE it fails: Is it the webhook not receiving emails? Tenant lookup failing? Email parsing breaking? Quote generation erroring? This phase adds diagnostic logging and documents findings.

Output: Enhanced webhook with step-by-step logging + DIAGNOSTICS.md documenting findings.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/webhooks/email_webhook.py
@src/api/routes.py (router registration)
@config/loader.py (tenant lookup)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add comprehensive diagnostic logging to email webhook</name>
  <files>src/webhooks/email_webhook.py</files>
  <action>
Add step-by-step diagnostic logging to `receive_inbound_email()` function in email_webhook.py.

Each log entry should include:
1. A unique DIAGNOSTIC_ID (UUID) generated at start of request for tracing
2. Structured log format: `[EMAIL_WEBHOOK][{DIAGNOSTIC_ID}][STEP_{N}] {message}`
3. Log the following steps with timing:

STEP_1: Request received - log timestamp, content-type, form fields present
STEP_2: Form data parsed - log each field (from, to, subject, envelope, body length)
STEP_3: Tenant resolution attempted - log each strategy tried (subdomain, plus addressing, header, subject)
STEP_4: Tenant resolution result - log success/failure with tenant_id or all strategies tried
STEP_5: Config loaded - log tenant config loaded or error
STEP_6: Background task queued - log what was passed to process_inbound_email

Also enhance `process_inbound_email()` with:
STEP_7: Processing started - log email details being processed
STEP_8: Email parser import - log success or import error (especially for UniversalEmailParser)
STEP_9: Email parsed - log parsed_data keys and values (destination, is_travel_inquiry, etc.)
STEP_10: Quote generation decision - log why proceeding/skipping quote generation
STEP_11: Quote result or skip reason - log quote_id or why it was skipped

Add a new diagnostic endpoint `GET /webhooks/email/diagnose` that returns:
- All webhook endpoints and their routes
- Current tenant list from list_clients()
- Environment variable status (SENDGRID_API_KEY set, OPENAI_API_KEY set)
- Python import test for UniversalEmailParser (success/error)
- Sample test of get_config() with a known tenant

This is diagnostic code - it can be verbose. Better to over-log than miss the failure.
  </action>
  <verify>
Run `python -c "from src.webhooks.email_webhook import router; print('Import OK')"` succeeds.
Grep for "DIAGNOSTIC_ID" in email_webhook.py returns matches.
  </verify>
  <done>
Webhook has 11 diagnostic steps logged with unique request IDs.
New /webhooks/email/diagnose endpoint exists and returns system state.
  </done>
</task>

<task type="auto">
  <name>Task 2: Analyze code flow and document current failure point</name>
  <files>.planning/phases/01-diagnostics-logging/01-DIAGNOSTICS.md</files>
  <action>
Create a diagnostic document by analyzing the current codebase. Document:

## 1. Webhook Registration Status
- Trace the router inclusion from main.py -> routes.py -> email_webhook_router
- Confirm endpoint paths: /webhooks/email/inbound, /webhooks/email/inbound/{tenant_id}, /webhooks/email/debug
- Check if any middleware might block webhook (auth_middleware.py - webhooks should be public)

## 2. Tenant Resolution Analysis
- Document the 4 strategies in extract_tenant_from_email()
- Check what tenant formats exist (ls clients/ directory)
- Note: Current code expects `{tenant_id}@inbound.domain.com` but SendGrid subusers are like `final-itc-3@zorah.ai`
- THIS IS LIKELY THE BUG: Tenant lookup expects tenant ID in email address, but emails go to SendGrid subuser addresses

## 3. Import Chain Analysis
- Check if UniversalEmailParser exists: `src/agents/universal_email_parser.py`
- If it doesn't exist, this is a failure point - document what file should contain it or what parser is actually available

## 4. SendGrid Configuration
Document expected vs actual:
- Expected domain: inbound.zorah.ai (from webhook status endpoint)
- Expected MX record: mx.sendgrid.net
- Actual subuser format: {name}@zorah.ai (from STATE.md)

## 5. Identified Failure Points
List each potential failure with evidence:
- [ ] Webhook not receiving (need Cloud Run logs)
- [ ] Tenant lookup failing (code analysis)
- [ ] Parser not found (import check)
- [ ] Quote agent error (need to trace)

## 6. Recommended Next Steps
Based on analysis, what needs to happen in Phase 2.
  </action>
  <verify>
File .planning/phases/01-diagnostics-logging/01-DIAGNOSTICS.md exists and contains sections for Webhook Registration, Tenant Resolution, Import Chain, SendGrid Configuration, and Identified Failure Points.
  </verify>
  <done>
DIAGNOSTICS.md documents current state with specific findings.
At least one concrete failure point is identified with evidence.
  </done>
</task>

<task type="auto">
  <name>Task 3: Test webhook locally and document results</name>
  <files>.planning/phases/01-diagnostics-logging/01-DIAGNOSTICS.md</files>
  <action>
Add test results to DIAGNOSTICS.md:

## 7. Local Testing Results

1. Start the server locally:
```bash
python main.py
```

2. Test the diagnose endpoint:
```bash
curl http://localhost:8080/webhooks/email/diagnose
```
Document the response.

3. Test the debug endpoint with mock SendGrid data:
```bash
curl -X POST http://localhost:8080/webhooks/email/debug \
  -F "from=test@example.com" \
  -F "to=final-itc-3@zorah.ai" \
  -F "subject=Test Zanzibar Quote" \
  -F "text=I want to visit Zanzibar in March" \
  -F "envelope={\"to\":[\"final-itc-3@zorah.ai\"],\"from\":\"test@example.com\"}"
```
Document what gets logged.

4. Test the main inbound endpoint:
```bash
curl -X POST http://localhost:8080/webhooks/email/inbound \
  -F "from=test@example.com" \
  -F "to=final-itc-3@zorah.ai" \
  -F "subject=Test Zanzibar Quote" \
  -F "text=I want to visit Zanzibar in March" \
  -F "envelope={\"to\":[\"final-itc-3@zorah.ai\"],\"from\":\"test@example.com\"}"
```
Document the response and any logged errors.

Update the ## Identified Failure Points section with concrete test results.
  </action>
  <verify>
DIAGNOSTICS.md contains "## 7. Local Testing Results" section with curl commands and actual responses.
  </verify>
  <done>
Local tests run and results documented.
Failure point confirmed or new failure discovered.
  </done>
</task>

</tasks>

<verification>
Phase 1 is complete when:
1. `grep -c "DIAGNOSTIC_ID" src/webhooks/email_webhook.py` returns > 0
2. `curl localhost:8080/webhooks/email/diagnose` returns JSON with tenant list
3. `.planning/phases/01-diagnostics-logging/01-DIAGNOSTICS.md` exists with 7 sections
4. At least one specific failure point is documented with evidence
</verification>

<success_criteria>
- Webhook has diagnostic logging (DIAGNOSTIC_ID visible in code)
- New /webhooks/email/diagnose endpoint returns system state
- DIAGNOSTICS.md documents current state comprehensively
- Current failure point identified with specific evidence (not speculation)
- Ready to proceed to Phase 2 with clear understanding of what to fix
</success_criteria>

<output>
After completion, create `.planning/phases/01-diagnostics-logging/01-01-SUMMARY.md`
</output>
