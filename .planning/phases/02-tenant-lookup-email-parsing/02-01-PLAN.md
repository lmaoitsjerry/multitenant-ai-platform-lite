---
phase: 02-tenant-lookup-email-parsing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/webhooks/email_webhook.py
autonomous: true

must_haves:
  truths:
    - "Tenant lookup finds tenant by support_email for any domain"
    - "Tenant lookup finds tenant by sendgrid_username@zorah.ai"
    - "Unknown emails return clear error with diagnostic ID"
    - "Lookup performance is acceptable (<500ms for 70 tenants)"
  artifacts:
    - path: "src/webhooks/email_webhook.py"
      provides: "find_tenant_by_email() function"
      contains: "find_tenant_by_email"
  key_links:
    - from: "POST /webhooks/email/inbound"
      to: "find_tenant_by_email()"
      via: "extract_tenant_from_email calls find_tenant_by_email"
      pattern: "find_tenant_by_email\\(to_email"
---

<objective>
Verify and optimize tenant lookup integration in the email webhook flow.

Purpose: Ensure Phase 1's tenant lookup fix works correctly end-to-end and is production-ready. Add any missing optimizations for performance with 70+ tenants.

Output: Verified and optimized tenant lookup that correctly routes emails to tenants.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-diagnostics-logging/01-01-SUMMARY.md
@src/webhooks/email_webhook.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tenant lookup caching for performance</name>
  <files>src/webhooks/email_webhook.py</files>
  <action>
The current `find_tenant_by_email()` iterates through ALL tenants on every email, calling `get_tenant_email_addresses()` for each. With 70+ tenants, this is inefficient.

Add a simple in-memory cache for tenant email mappings:

1. Create a module-level cache dict: `_tenant_email_cache = {}`
2. Create cache TTL constant: `TENANT_CACHE_TTL = 300` (5 minutes)
3. Create `_refresh_tenant_email_cache()` function that:
   - Gets all tenant IDs via `list_clients()`
   - For each tenant, calls `get_tenant_email_addresses()`
   - Builds inverse lookup dict: `{email.lower(): tenant_id}`
   - Stores in cache with timestamp
4. Modify `find_tenant_by_email()` to:
   - Check if cache exists and is fresh (< TTL)
   - If stale, call `_refresh_tenant_email_cache()`
   - Do O(1) lookup in cache instead of O(n) iteration
   - Fall back to original iteration if cache miss (defensive)

Log cache refresh events at INFO level.

DO NOT change the external API or behavior - this is purely an internal optimization.
  </action>
  <verify>
Grep for `_tenant_email_cache` in email_webhook.py shows cache implementation.
Grep for `TENANT_CACHE_TTL` shows TTL constant.
  </verify>
  <done>
Tenant lookup uses cached email->tenant mapping with 5-minute TTL.
Cache refresh logged at INFO level.
Fallback to iteration on cache miss.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add diagnostic endpoint for tenant email verification</name>
  <files>src/webhooks/email_webhook.py</files>
  <action>
Add a new endpoint `GET /webhooks/email/lookup/{email}` that:

1. Takes an email address as path parameter
2. Calls `find_tenant_by_email(email, diagnostic_id)`
3. Returns JSON with:
   - `found: bool`
   - `tenant_id: str | null`
   - `strategy: str` (support_email, sendgrid_email, primary_email, none)
   - `diagnostic_id: str`
   - `cache_hit: bool` (whether result came from cache)
   - `elapsed_ms: float`

This allows testing tenant lookup without sending full emails.

Example response for found tenant:
```json
{
  "found": true,
  "tenant_id": "africastay",
  "strategy": "sendgrid_email",
  "matched_email": "final-itc-3@zorah.ai",
  "diagnostic_id": "ABC12345",
  "cache_hit": true,
  "elapsed_ms": 2.5
}
```

Example response for not found:
```json
{
  "found": false,
  "tenant_id": null,
  "strategy": "none",
  "diagnostic_id": "DEF67890",
  "cache_hit": true,
  "elapsed_ms": 1.2,
  "suggestion": "Email not registered. Check tenant_settings.support_email or sendgrid_username."
}
```
  </action>
  <verify>
`curl http://localhost:8000/webhooks/email/lookup/test@example.com` returns JSON response.
Response includes found, tenant_id, strategy, diagnostic_id fields.
  </verify>
  <done>
GET /webhooks/email/lookup/{email} endpoint exists and returns lookup results with timing.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify tenant lookup with unit tests</name>
  <files>tests/test_email_webhook.py</files>
  <action>
Create unit tests for tenant email lookup (new file if doesn't exist):

```python
import pytest
from unittest.mock import patch, MagicMock
from src.webhooks.email_webhook import (
    find_tenant_by_email,
    extract_tenant_from_email,
    _refresh_tenant_email_cache,
    _tenant_email_cache
)

class TestTenantLookup:
    """Test tenant email lookup functionality"""

    def setup_method(self):
        """Clear cache before each test"""
        _tenant_email_cache.clear()

    @patch('src.webhooks.email_webhook.list_clients')
    @patch('src.webhooks.email_webhook.get_tenant_email_addresses')
    def test_find_tenant_by_support_email(self, mock_get_emails, mock_list):
        """Should find tenant by support_email"""
        mock_list.return_value = ['tenant1']
        mock_get_emails.return_value = {
            'support_email': 'support@company.com',
            'sendgrid_email': None,
            'primary_email': None,
            'tenant_id': 'tenant1'
        }

        tenant_id, strategy = find_tenant_by_email('support@company.com')
        assert tenant_id == 'tenant1'
        assert strategy == 'support_email'

    @patch('src.webhooks.email_webhook.list_clients')
    @patch('src.webhooks.email_webhook.get_tenant_email_addresses')
    def test_find_tenant_by_sendgrid_email(self, mock_get_emails, mock_list):
        """Should find tenant by sendgrid_username@zorah.ai"""
        mock_list.return_value = ['tenant1']
        mock_get_emails.return_value = {
            'support_email': None,
            'sendgrid_email': 'final-itc-3@zorah.ai',
            'primary_email': None,
            'tenant_id': 'tenant1'
        }

        tenant_id, strategy = find_tenant_by_email('final-itc-3@zorah.ai')
        assert tenant_id == 'tenant1'
        assert strategy == 'sendgrid_email'

    @patch('src.webhooks.email_webhook.list_clients')
    @patch('src.webhooks.email_webhook.get_tenant_email_addresses')
    def test_find_tenant_case_insensitive(self, mock_get_emails, mock_list):
        """Should match emails case-insensitively"""
        mock_list.return_value = ['tenant1']
        mock_get_emails.return_value = {
            'support_email': 'Support@Company.COM',
            'sendgrid_email': None,
            'primary_email': None,
            'tenant_id': 'tenant1'
        }

        tenant_id, strategy = find_tenant_by_email('SUPPORT@company.com')
        assert tenant_id == 'tenant1'

    @patch('src.webhooks.email_webhook.list_clients')
    @patch('src.webhooks.email_webhook.get_tenant_email_addresses')
    def test_not_found_returns_none(self, mock_get_emails, mock_list):
        """Should return None for unknown emails"""
        mock_list.return_value = ['tenant1']
        mock_get_emails.return_value = {
            'support_email': 'other@company.com',
            'sendgrid_email': None,
            'primary_email': None,
            'tenant_id': 'tenant1'
        }

        tenant_id, strategy = find_tenant_by_email('unknown@nowhere.com')
        assert tenant_id is None
        assert strategy == 'none'
```

Run: `pytest tests/test_email_webhook.py -v`
  </action>
  <verify>
`pytest tests/test_email_webhook.py -v` passes all tests.
At least 4 test cases exist for tenant lookup.
  </verify>
  <done>
Unit tests verify tenant lookup works for support_email, sendgrid_email, case-insensitive matching, and unknown emails.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Cache verification:**
   ```bash
   grep -n "_tenant_email_cache" src/webhooks/email_webhook.py
   ```
   Should show cache dict and usage.

2. **Endpoint verification:**
   ```bash
   grep -n "lookup/{email}" src/webhooks/email_webhook.py
   ```
   Should show new endpoint.

3. **Test verification:**
   ```bash
   pytest tests/test_email_webhook.py -v
   ```
   Should pass all tests.

4. **Functional verification:**
   Start server and test:
   ```bash
   curl http://localhost:8000/webhooks/email/lookup/final-itc-3@zorah.ai
   ```
   Should return tenant lookup result with timing.
</verification>

<success_criteria>
1. Tenant lookup uses O(1) cached lookup instead of O(n) iteration
2. Cache refreshes every 5 minutes automatically
3. New /webhooks/email/lookup/{email} endpoint works
4. Unit tests pass for all lookup scenarios
5. No breaking changes to existing webhook behavior
</success_criteria>

<output>
After completion, create `.planning/phases/02-tenant-lookup-email-parsing/02-01-SUMMARY.md`
</output>
