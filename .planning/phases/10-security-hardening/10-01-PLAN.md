---
phase: 10-security-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/error_handler.py
  - src/api/routes.py
  - src/api/admin_routes.py
  - src/api/admin_knowledge_routes.py
  - src/api/admin_sendgrid_routes.py
  - src/api/admin_tenants_routes.py
  - src/api/admin_analytics_routes.py
  - src/api/analytics_routes.py
  - src/api/pricing_routes.py
  - src/api/privacy_routes.py
  - src/api/branding_routes.py
  - src/api/notifications_routes.py
  - src/api/inbound_routes.py
  - src/api/templates_routes.py
  - src/api/knowledge_routes.py
  - src/webhooks/email_webhook.py
autonomous: true

must_haves:
  truths:
    - "Error responses never expose internal exception messages to clients"
    - "Errors are logged with full details for debugging"
    - "Generic error messages are returned to API consumers"
  artifacts:
    - path: "src/utils/error_handler.py"
      provides: "Central error handling utility"
      exports: ["safe_error_response", "log_and_raise"]
    - path: "src/api/routes.py"
      provides: "Routes using safe error handler"
      contains: "safe_error_response"
  key_links:
    - from: "src/api/*.py"
      to: "src/utils/error_handler.py"
      via: "import"
      pattern: "from src.utils.error_handler import"
---

<objective>
Sanitize all error responses across the API to prevent exposing internal exception details.

Purpose: Attackers can use detailed error messages to understand system internals and find vulnerabilities. Generic error messages prevent information leakage while still providing useful feedback to developers via logs.

Output: Central error handler utility and all 93 instances of `detail=str(e)` replaced with safe error responses.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/api/routes.py
@src/api/admin_routes.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create central error handler utility</name>
  <files>src/utils/error_handler.py</files>
  <action>
Create a new utility module with two functions:

1. `safe_error_response(status_code: int, operation: str, exception: Exception, logger: logging.Logger) -> HTTPException`:
   - Logs the full exception with traceback at ERROR level: `logger.error(f"{operation} failed: {exception}", exc_info=True)`
   - Returns HTTPException with generic message based on operation:
     - For 500: "An internal error occurred while {operation}. Please try again later."
     - For 4xx: Keep as-is (client errors can be specific)
   - Never includes str(e) in the HTTPException detail

2. `log_and_raise(status_code: int, operation: str, exception: Exception, logger: logging.Logger)`:
   - Convenience function that logs and raises in one call
   - Uses safe_error_response internally
   - Raises the HTTPException directly

Example usage pattern to replace:
```python
# BEFORE:
except Exception as e:
    logger.error(f"Failed to list quotes: {e}")
    raise HTTPException(status_code=500, detail=str(e))

# AFTER:
except Exception as e:
    log_and_raise(500, "listing quotes", e, logger)
```

Include standard imports (logging, fastapi.HTTPException, typing).
  </action>
  <verify>
    - File exists at src/utils/error_handler.py
    - Both functions are defined with correct signatures
    - `python -c "from src.utils.error_handler import safe_error_response, log_and_raise"` succeeds
  </verify>
  <done>Error handler utility exists with safe_error_response and log_and_raise functions</done>
</task>

<task type="auto">
  <name>Task 2: Replace detail=str(e) in all API routes (Part 1 - High volume files)</name>
  <files>
    src/api/routes.py
    src/api/privacy_routes.py
    src/api/admin_sendgrid_routes.py
    src/api/admin_knowledge_routes.py
  </files>
  <action>
Replace all instances of `detail=str(e)` in the high-volume files (routes.py has 25, privacy_routes.py has 12, admin_sendgrid_routes.py has 8, admin_knowledge_routes.py has 7).

Pattern to find and replace:
```python
# Find this pattern:
except Exception as e:
    logger.error(f"...: {e}")
    raise HTTPException(status_code=500, detail=str(e))

# Replace with:
except Exception as e:
    log_and_raise(500, "descriptive operation name", e, logger)
```

Add import at top of each file:
```python
from src.utils.error_handler import log_and_raise
```

For the operation name, derive it from the existing log message. Examples:
- "Failed to list quotes" -> "listing quotes"
- "Error creating client" -> "creating client"
- "Quote generation failed" -> "generating quote"

IMPORTANT:
- Keep 4xx HTTPExceptions with specific messages (auth errors, validation errors, not found) - only change 500 errors
- Do NOT change HTTPException in auth_routes.py - those have intentional specific messages
  </action>
  <verify>
    - `grep -c "detail=str(e)" src/api/routes.py` returns 0
    - `grep -c "detail=str(e)" src/api/privacy_routes.py` returns 0
    - `grep -c "detail=str(e)" src/api/admin_sendgrid_routes.py` returns 0
    - `grep -c "detail=str(e)" src/api/admin_knowledge_routes.py` returns 0
    - `grep -c "from src.utils.error_handler import" src/api/routes.py` returns 1
  </verify>
  <done>52 instances of detail=str(e) replaced in high-volume files</done>
</task>

<task type="auto">
  <name>Task 3: Replace detail=str(e) in remaining API routes (Part 2)</name>
  <files>
    src/api/admin_routes.py
    src/api/admin_tenants_routes.py
    src/api/admin_analytics_routes.py
    src/api/analytics_routes.py
    src/api/pricing_routes.py
    src/api/branding_routes.py
    src/api/notifications_routes.py
    src/api/inbound_routes.py
    src/api/templates_routes.py
    src/api/knowledge_routes.py
    src/webhooks/email_webhook.py
  </files>
  <action>
Replace remaining ~41 instances of `detail=str(e)` in lower-volume files.

Same pattern as Task 2:
1. Add import: `from src.utils.error_handler import log_and_raise`
2. Replace `raise HTTPException(status_code=500, detail=str(e))` with `log_and_raise(500, "operation", e, logger)`

Files and approximate counts:
- admin_routes.py: 2 instances
- admin_tenants_routes.py: 6 instances
- admin_analytics_routes.py: 4 instances
- analytics_routes.py: 6 instances
- pricing_routes.py: 6 instances
- branding_routes.py: 2 instances
- notifications_routes.py: 5 instances
- inbound_routes.py: 5 instances
- templates_routes.py: 2 instances
- knowledge_routes.py: 1 instance
- email_webhook.py: 2 instances

Use descriptive operation names derived from log messages or endpoint names.
  </action>
  <verify>
    - `grep -r "detail=str(e)" src/api/ src/webhooks/` returns only auth_routes.py entries (if any) or empty
    - All modified files have the error_handler import
    - `python -c "from src.api.routes import *"` succeeds (imports work)
  </verify>
  <done>All 93 instances of detail=str(e) replaced with safe error handler</done>
</task>

</tasks>

<verification>
Run the following checks after all tasks complete:

1. **Count remaining instances:**
   ```bash
   grep -r "detail=str(e)" src/api/ src/webhooks/ --include="*.py" | wc -l
   # Expected: 0 (or only intentional auth-related ones)
   ```

2. **Verify imports work:**
   ```bash
   python -c "from src.utils.error_handler import safe_error_response, log_and_raise; print('OK')"
   ```

3. **Spot check a route file:**
   ```bash
   grep "log_and_raise" src/api/routes.py | head -5
   # Should show usage of the new function
   ```

4. **Run existing tests:**
   ```bash
   pytest tests/ -v --tb=short
   # Existing tests should still pass
   ```
</verification>

<success_criteria>
- [ ] src/utils/error_handler.py exists with safe_error_response and log_and_raise
- [ ] All 93 instances of detail=str(e) replaced across 15 files
- [ ] Each modified file imports from src.utils.error_handler
- [ ] No information leakage in error responses (generic messages only)
- [ ] Full exception details still logged for debugging
- [ ] Existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-security-hardening/10-01-SUMMARY.md`
</output>
