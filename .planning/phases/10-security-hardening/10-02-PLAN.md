---
phase: 10-security-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/middleware/security_headers.py
  - main.py
autonomous: true

must_haves:
  truths:
    - "All API responses include X-Frame-Options header"
    - "All API responses include X-Content-Type-Options header"
    - "All API responses include Strict-Transport-Security header"
    - "All API responses include Content-Security-Policy header"
    - "All API responses include Referrer-Policy header"
  artifacts:
    - path: "src/middleware/security_headers.py"
      provides: "Security headers middleware"
      exports: ["SecurityHeadersMiddleware"]
    - path: "main.py"
      provides: "Middleware registration"
      contains: "SecurityHeadersMiddleware"
  key_links:
    - from: "main.py"
      to: "src/middleware/security_headers.py"
      via: "middleware registration"
      pattern: "app.add_middleware\\(SecurityHeadersMiddleware\\)"
---

<objective>
Add security headers middleware to protect against common web vulnerabilities.

Purpose: Security headers instruct browsers to enable security features that protect users from XSS, clickjacking, MIME sniffing, and protocol downgrade attacks. These headers are a low-cost, high-impact security measure required for production readiness.

Output: SecurityHeadersMiddleware that adds CSP, X-Frame-Options, HSTS, X-Content-Type-Options, X-XSS-Protection, and Referrer-Policy to all responses.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@main.py
@src/middleware/auth_middleware.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create security headers middleware</name>
  <files>src/middleware/security_headers.py</files>
  <action>
Create a new middleware that adds security headers to all responses.

```python
"""
Security Headers Middleware

Adds security headers to all API responses to protect against common
web vulnerabilities like XSS, clickjacking, and MIME sniffing.

Headers added:
- X-Frame-Options: Prevents clickjacking
- X-Content-Type-Options: Prevents MIME sniffing
- X-XSS-Protection: Enables browser XSS filtering (legacy, but harmless)
- Strict-Transport-Security: Enforces HTTPS
- Content-Security-Policy: Restricts resource loading
- Referrer-Policy: Controls referrer information
"""

import os
import logging
from starlette.middleware.base import BaseHTTPMiddleware
from fastapi import Request, Response

logger = logging.getLogger(__name__)


class SecurityHeadersMiddleware(BaseHTTPMiddleware):
    """Middleware that adds security headers to all responses."""

    # Default CSP for API-only responses (restrictive)
    DEFAULT_CSP = "default-src 'none'; frame-ancestors 'none'"

    # Environment variable to customize CSP if needed
    # e.g., for embedded widgets: "default-src 'self'; frame-ancestors https://trusted.com"

    async def dispatch(self, request: Request, call_next) -> Response:
        response = await call_next(request)

        # Get CSP from environment or use default
        csp = os.getenv("SECURITY_CSP", self.DEFAULT_CSP)

        # Clickjacking protection
        response.headers["X-Frame-Options"] = "DENY"

        # Prevent MIME sniffing
        response.headers["X-Content-Type-Options"] = "nosniff"

        # Legacy XSS protection (modern browsers ignore, but harmless)
        response.headers["X-XSS-Protection"] = "1; mode=block"

        # Force HTTPS (only add in production)
        # max-age=31536000 = 1 year, includeSubDomains for full domain protection
        if os.getenv("ENVIRONMENT", "development") != "development":
            response.headers["Strict-Transport-Security"] = "max-age=31536000; includeSubDomains"

        # Content Security Policy - restrictive for API
        response.headers["Content-Security-Policy"] = csp

        # Referrer policy - don't leak URLs on cross-origin requests
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"

        # Permissions policy - disable unnecessary browser features
        response.headers["Permissions-Policy"] = "geolocation=(), camera=(), microphone=()"

        return response
```

This middleware:
1. Adds security headers to ALL responses
2. Allows CSP customization via SECURITY_CSP environment variable
3. Only adds HSTS in non-development environments (to not break local HTTP)
4. Uses restrictive defaults suitable for an API
  </action>
  <verify>
    - File exists at src/middleware/security_headers.py
    - `python -c "from src.middleware.security_headers import SecurityHeadersMiddleware; print('OK')"` succeeds
  </verify>
  <done>Security headers middleware created with all required headers</done>
</task>

<task type="auto">
  <name>Task 2: Register security headers middleware in FastAPI app</name>
  <files>main.py</files>
  <action>
Add the SecurityHeadersMiddleware to the FastAPI application.

Find the middleware section in main.py (around line 77-95) and add the security headers middleware.

The middleware should be added AFTER CORS middleware (so security headers are added to CORS preflight responses) but BEFORE other middleware.

Add the import near other middleware imports:
```python
from src.middleware.security_headers import SecurityHeadersMiddleware
```

Add middleware registration in the middleware section. Add it as number 5 (after TimingMiddleware, before CORS):
```python
# 5. Security headers middleware - adds CSP, X-Frame-Options, HSTS, etc.
app.add_middleware(SecurityHeadersMiddleware)
```

The order should be (remember: FastAPI middleware runs in REVERSE order):
1. PII Audit (first to process requests = last added)
2. Auth middleware
3. Rate limiting middleware
4. Timing middleware
5. **Security headers middleware** (NEW)
6. CORS middleware (last to process requests = first added)

IMPORTANT: The security headers middleware should be added AFTER the CORS setup in main.py to ensure CORS headers are not overwritten.
  </action>
  <verify>
    - `grep "SecurityHeadersMiddleware" main.py` shows the import and registration
    - `python -c "import main; print('OK')"` succeeds (app loads without errors)
  </verify>
  <done>Security headers middleware registered in FastAPI app</done>
</task>

</tasks>

<verification>
Run the following checks after all tasks complete:

1. **Verify middleware loads:**
   ```bash
   python -c "import main; print('App loaded successfully')"
   ```

2. **Test security headers are present (requires running server):**
   ```bash
   # Start server in background (or use existing)
   # Then test with curl:
   curl -I http://localhost:8000/health 2>/dev/null | grep -E "(X-Frame|X-Content|Content-Security|Referrer)"
   # Expected: Headers present in response
   ```

3. **Run existing tests to ensure no regression:**
   ```bash
   pytest tests/test_auth_middleware.py -v --tb=short
   # Should pass (no interference with auth)
   ```
</verification>

<success_criteria>
- [ ] src/middleware/security_headers.py exists with SecurityHeadersMiddleware class
- [ ] Middleware registered in main.py
- [ ] X-Frame-Options: DENY header present
- [ ] X-Content-Type-Options: nosniff header present
- [ ] Content-Security-Policy header present
- [ ] Referrer-Policy header present
- [ ] X-XSS-Protection header present
- [ ] HSTS only added in non-development environment
- [ ] Existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-security-hardening/10-02-SUMMARY.md`
</output>
