# Plan 02-01: Fix Invoice paid_at Field

## Objective
Fix revenue calculations by properly setting `paid_at` timestamp when invoices are marked as paid.

## Problem
1. `update_invoice_status()` saves to `payment_date` but schema uses `paid_at`
2. Admin analytics uses `created_at` for "this month" filtering instead of `paid_at`
3. Revenue shows $0 because:
   - `paid_at` field never gets set
   - "This month" filter matches by invoice creation date, not payment date

## Root Cause Analysis
- `src/tools/supabase_tool.py:499` - saves `payment_date` not `paid_at`
- `src/api/admin_analytics_routes.py:199-201` - filters by `created_at` not `paid_at`

## Solution

### 1. Fix supabase_tool.py - Set paid_at when status = "paid"
```python
if status == 'paid':
    # Set paid_at timestamp when invoice is marked as paid
    update_data['paid_at'] = datetime.utcnow().isoformat()
if payment_date:
    update_data['paid_at'] = payment_date.isoformat()
```

### 2. Fix admin_analytics_routes.py - Query paid_at for revenue
- Fetch `paid_at` field along with other invoice fields
- Filter "this month paid" by `paid_at` date, not `created_at`

## Files to Modify
- `src/tools/supabase_tool.py` - update_invoice_status()
- `src/api/admin_analytics_routes.py` - get_all_invoices_stats()

## Success Criteria
- [x] `paid_at` set automatically when status changed to "paid"
- [x] `paid_at` can be overridden with explicit payment_date
- [x] Admin revenue shows correct totals
- [x] "This month revenue" filters by actual payment date

## Changes Made
1. `supabase_tool.py:498-502` - Now sets `paid_at` when status is "paid"
2. `admin_analytics_routes.py:180` - Queries `paid_at` field
3. `admin_analytics_routes.py:200-202` - Uses `paid_at` for "this month" filtering with fallback

---
*Status: Complete*
*Created: 2026-01-16*
*Completed: 2026-01-16*
