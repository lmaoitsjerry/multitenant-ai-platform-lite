---
phase: 18-code-quality-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/admin_tenants_routes.py
  - src/api/admin_analytics_routes.py
  - src/api/admin_knowledge_routes.py
  - src/api/helpdesk_routes.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "All functions in admin_tenants_routes.py use consistent async/sync patterns"
    - "get_supabase_admin_client() is async-compatible (returns client, calls are awaited)"
    - "Type hints exist on all public functions in modified files"
  artifacts:
    - path: "src/api/admin_tenants_routes.py"
      provides: "Async-safe Supabase client usage"
      contains: "async def get_supabase_admin_client"
    - path: "src/api/admin_analytics_routes.py"
      provides: "Type-hinted functions"
      contains: "-> Dict[str, Any]"
    - path: "src/api/admin_knowledge_routes.py"
      provides: "Type-hinted functions"
      contains: "-> Optional["
    - path: "src/api/helpdesk_routes.py"
      provides: "Type-hinted functions"
      contains: ") -> "
  key_links:
    - from: "src/api/admin_tenants_routes.py"
      to: "supabase.client"
      via: "await run_in_executor pattern"
      pattern: "loop.run_in_executor|asyncio.to_thread"
---

<objective>
Fix async/sync mismatch in admin routes and add type hints to public functions.

Purpose: PROD-11 (async/sync mismatch) and PROD-12 (type hints) require consistent async patterns and explicit type annotations for maintainability and runtime safety.

Output: Updated route files with proper async handling and type hints on all public API functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/PRODUCTION-AUDIT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix async/sync mismatch in admin_tenants_routes.py</name>
  <files>src/api/admin_tenants_routes.py</files>
  <action>
  The file has async endpoint functions calling synchronous Supabase client methods directly. Fix this:

  1. Convert `get_supabase_admin_client()` to return client but wrap synchronous Supabase calls:
     - Use `asyncio.to_thread()` for Python 3.9+ OR `loop.run_in_executor(None, ...)` for sync Supabase calls
     - Alternative: Use `anyio.to_thread.run_sync()` if anyio is available

  2. In `get_tenant_stats_from_db()` (line 130-176):
     - Wrap each `client.table(...).execute()` call in async executor
     - Example: `result = await asyncio.to_thread(lambda: client.table("quotes").select("id", count="exact").eq("tenant_id", tenant_id).execute())`

  3. In all endpoint functions that call `get_supabase_admin_client()`:
     - Ensure database operations use async wrappers
     - Keep the existing try/except error handling

  4. Add import at top: `import asyncio`

  Do NOT change the Supabase client itself (it's synchronous by design).
  Use the executor pattern to make sync calls non-blocking in async context.
  </action>
  <verify>
  Run: `python -c "import src.api.admin_tenants_routes; print('Import OK')"`
  Run: `python -m py_compile src/api/admin_tenants_routes.py`
  </verify>
  <done>
  - get_tenant_stats_from_db uses asyncio.to_thread for Supabase calls
  - All endpoint database calls are wrapped in async executor
  - No synchronous blocking in async functions
  </done>
</task>

<task type="auto">
  <name>Task 2: Add type hints to public functions in admin routes</name>
  <files>src/api/admin_tenants_routes.py, src/api/admin_analytics_routes.py, src/api/admin_knowledge_routes.py, src/api/helpdesk_routes.py</files>
  <action>
  Add type hints to all public functions (those used externally or as endpoints):

  1. In admin_tenants_routes.py:
     - `get_supabase_admin_client() -> Optional[Client]` (add from supabase import Client)
     - `get_tenant_stats_from_db(tenant_id: str) -> Dict[str, Any]`
     - `include_admin_tenants_router(app: FastAPI) -> None`

  2. In admin_analytics_routes.py (line 124):
     - `get_supabase_admin_client() -> Optional[Client]`
     - `include_admin_analytics_router(app: FastAPI) -> None`

  3. In admin_knowledge_routes.py (lines 126, 136):
     - `get_gcs_client() -> Optional[storage.Client]`
     - `get_gcs_bucket() -> Optional[storage.Bucket]`
     - `include_admin_knowledge_router(app: FastAPI) -> None`

  4. In helpdesk_routes.py:
     - `get_faiss_status() -> Dict[str, Any]`
     - `helpdesk_health() -> Dict[str, Any]`
     - `agent_reset() -> Dict[str, Any]`
     - `agent_stats() -> Dict[str, Any]`
     - `list_accuracy_test_cases() -> Dict[str, Any]`
     - `include_helpdesk_router(app: FastAPI) -> None`

  Add necessary imports:
  - `from typing import Dict, Any, Optional, List`
  - `from fastapi import FastAPI` (if not already imported)
  </action>
  <verify>
  Run: `python -m py_compile src/api/admin_tenants_routes.py src/api/admin_analytics_routes.py src/api/admin_knowledge_routes.py src/api/helpdesk_routes.py`
  Run: `python -c "from src.api.admin_tenants_routes import *; from src.api.admin_analytics_routes import *; print('Imports OK')"`
  </verify>
  <done>
  - All public functions have explicit return type hints
  - All function parameters have type hints
  - Typing imports added where needed
  </done>
</task>

</tasks>

<verification>
1. All modified files compile without errors: `python -m py_compile src/api/*.py`
2. Existing tests still pass: `pytest tests/test_admin_routes.py tests/test_admin_knowledge_routes.py -v --tb=short`
3. No mypy errors on modified files (if mypy available): `mypy src/api/admin_tenants_routes.py --ignore-missing-imports`
</verification>

<success_criteria>
- PROD-11: Async/sync mismatch fixed - no synchronous blocking in async endpoint functions
- PROD-12: Type hints on all public functions - explicit return types and parameter types
- All existing tests pass
- Files compile without syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-code-quality-optimization/18-01-SUMMARY.md`
</output>
