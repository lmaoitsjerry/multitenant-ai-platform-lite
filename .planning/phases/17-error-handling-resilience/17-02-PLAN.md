---
phase: 17-error-handling-resilience
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/webhooks/email_webhook.py
  - src/api/analytics_routes.py
  - src/tools/supabase_tool.py
  - src/agents/quote_agent.py
  - src/api/routes.py
  - src/services/auth_service.py
  - src/utils/logger.py
autonomous: true

must_haves:
  truths:
    - "No bare except: clauses remain in the codebase"
    - "All exception handlers log the error with proper context"
    - "Helpdesk returns graceful fallback when OpenAI is unavailable"
    - "Unused logger.py file is removed"
  artifacts:
    - path: "src/webhooks/email_webhook.py"
      provides: "Proper exception handling with logging"
      contains: "except Exception as e:"
    - path: "src/api/analytics_routes.py"
      provides: "Proper exception handling with logging"
      contains: "except Exception as e:"
  key_links:
    - from: "src/webhooks/email_webhook.py"
      to: "logger"
      via: "exception logging"
      pattern: "logger\\.(warning|error|debug)"
  notes:
    - "PROD-09 (Standardize error handling on safe_error_response) is already satisfied - grep confirms 114 uses of log_and_raise() across 15 API files and 0 instances of HTTPException(detail=str(e)). This was completed in Phase 10 (SEC-03)."
---

<objective>
Remove all bare exception handlers and add proper error logging. Implement graceful degradation for helpdesk when OpenAI is unavailable. Remove unused logger.py.

Purpose: Bare `except:` clauses swallow errors silently, making debugging impossible. Production systems need proper error logging to diagnose issues. Graceful degradation ensures users get useful responses even when services fail.

Output: All bare exception handlers replaced with proper logging, unused logger.py deleted.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/PRODUCTION-AUDIT.md
@src/utils/error_handler.py
@src/utils/structured_logger.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix bare exceptions in email_webhook.py</name>
  <files>src/webhooks/email_webhook.py</files>
  <action>
Replace all bare `except:` clauses with proper exception handling. There are 8 instances:

1. Line 320 (extract_tenant_from_email, get_config fallback):
```python
# BEFORE:
        except:
            pass
# AFTER:
        except Exception as e:
            logger.debug(f"Config lookup failed for {local_part}: {e}")
```

2. Line 334 (plus addressing, get_config fallback):
```python
# BEFORE:
        except:
            pass
# AFTER:
        except Exception as e:
            logger.debug(f"Plus addressing config lookup failed for {tenant}: {e}")
```

3. Line 349 (X-Tenant-ID header, get_config fallback):
```python
# BEFORE:
            except:
                pass
# AFTER:
            except Exception as e:
                logger.debug(f"X-Tenant-ID header config lookup failed for {tenant_header}: {e}")
```

4. Line 368 (extract_tenant_from_subject, get_config fallback):
```python
# BEFORE:
        except:
            pass
# AFTER:
        except Exception as e:
            logger.debug(f"Subject pattern config lookup failed for {tenant}: {e}")
```

5. Line 422 (receive_inbound_email, JSON parse):
```python
# BEFORE:
        except:
            envelope = {}
# AFTER:
        except json.JSONDecodeError as e:
            logger.debug(f"Failed to parse envelope JSON: {e}")
            envelope = {}
```

6. Line 761 (lookup_tenant_by_email, get emails fallback):
```python
# BEFORE:
        except:
            matched_email = email
# AFTER:
        except Exception as e:
            logger.debug(f"Failed to get tenant emails for {tenant_id}: {e}")
            matched_email = email
```

7. Line 936 (receive_tenant_email, get_config validation):
```python
# BEFORE:
        except:
            raise HTTPException(status_code=404, detail=f"Tenant not found: {tenant_id}")
# AFTER:
        except Exception as e:
            logger.warning(f"Tenant config lookup failed for {tenant_id}: {e}")
            raise HTTPException(status_code=404, detail=f"Tenant not found: {tenant_id}")
```

8. Line 1007 (test_email_processing, get_config validation):
```python
# BEFORE:
    except:
        raise HTTPException(status_code=404, detail=f"Tenant not found: {tenant_id}")
# AFTER:
    except Exception as e:
        logger.warning(f"Test endpoint tenant lookup failed for {tenant_id}: {e}")
        raise HTTPException(status_code=404, detail=f"Tenant not found: {tenant_id}")
```

Note: Add `import json` at top if not already present (for JSONDecodeError).
  </action>
  <verify>
```bash
grep -n "except:" src/webhooks/email_webhook.py | wc -l
# Should return 0
```
  </verify>
  <done>All 8 bare exception handlers in email_webhook.py replaced with proper exception handling and logging</done>
</task>

<task type="auto">
  <name>Task 2: Fix bare exceptions in analytics_routes.py</name>
  <files>src/api/analytics_routes.py</files>
  <action>
Replace all bare `except:` clauses with proper exception handling. There are 7 instances:

1. Line 175 (get_dashboard_stats, date parsing in overdue check):
```python
# BEFORE:
                        except:
                            pass
# AFTER:
                        except (ValueError, TypeError) as e:
                            logger.debug(f"Failed to parse due_date {due_date}: {e}")
```

2. Line 447 (get_quote_analytics, trend date parsing):
```python
# BEFORE:
                except:
                    pass
# AFTER:
                except (ValueError, TypeError) as e:
                    logger.debug(f"Failed to parse quote created_at: {e}")
```

3. Line 562 (get_invoice_analytics, aging date parsing):
```python
# BEFORE:
                    except:
                        result["aging"]["current"] += amount
# AFTER:
                    except (ValueError, TypeError) as e:
                        logger.debug(f"Failed to parse invoice due_date: {e}")
                        result["aging"]["current"] += amount
```

4. Line 599 (get_invoice_analytics, trend date parsing):
```python
# BEFORE:
                except:
                    pass
# AFTER:
                except (ValueError, TypeError) as e:
                    logger.debug(f"Failed to parse invoice created_at: {e}")
```

5. Lines 740-742 (get_call_analytics, trend processing):
```python
# BEFORE:
                    except:
                        pass
        except:
            pass
# AFTER:
                    except (ValueError, TypeError) as e:
                        logger.debug(f"Failed to parse call created_at: {e}")
        except Exception as e:
            logger.debug(f"Failed to process call trend data: {e}")
```

6. Line 883 (fetch_usage inner function):
```python
# BEFORE:
            except:
                return {}
# AFTER:
            except Exception as e:
                logger.warning(f"Failed to fetch usage stats: {e}")
                return {}
```
  </action>
  <verify>
```bash
grep -n "except:" src/api/analytics_routes.py | wc -l
# Should return 0
```
  </verify>
  <done>All 7 bare exception handlers in analytics_routes.py replaced with proper exception handling and logging</done>
</task>

<task type="auto">
  <name>Task 3: Fix remaining bare exceptions and delete unused logger.py</name>
  <files>src/tools/supabase_tool.py, src/agents/quote_agent.py, src/api/routes.py, src/services/auth_service.py, src/utils/logger.py</files>
  <action>
Fix remaining bare exceptions (4 files) and delete unused logger.py:

1. **src/tools/supabase_tool.py** (line 1123, storage duplicate fallback):
```python
# BEFORE:
                except:
                    raise Exception("File already exists and could not be replaced.")
# AFTER:
                except Exception as e:
                    logger.warning(f"Failed to get public URL for existing file: {e}")
                    raise Exception("File already exists and could not be replaced.")
```

2. **src/agents/quote_agent.py** (lines 647 and 682, date parsing):
```python
# Line 647 - date range parsing
# BEFORE:
        except:
            dates = (None, None)
# AFTER:
        except (ValueError, TypeError) as e:
            logger.debug(f"Failed to parse date range: {e}")
            dates = (None, None)

# Line 682 - single date parsing
# BEFORE:
        except:
            return None
# AFTER:
        except (ValueError, TypeError) as e:
            logger.debug(f"Failed to parse date string: {e}")
            return None
```

3. **src/api/routes.py** (line 742, hotels JSON parsing):
```python
# BEFORE:
                    except:
                        pass
# AFTER:
                    except (json.JSONDecodeError, TypeError) as e:
                        logger.debug(f"Failed to parse hotels JSON: {e}")
```

4. **src/services/auth_service.py** (line 359, user lookup):
```python
# BEFORE:
                    except:
                        pass
# AFTER:
                    except Exception as e:
                        logger.debug(f"User lookup failed: {e}")
```

5. **Delete src/utils/logger.py**:
This file is unused (conflicts with structured_logger.py which is the correct implementation).
```bash
rm src/utils/logger.py
```
  </action>
  <verify>
```bash
# Verify no bare exceptions remain in any modified files
grep -r "except:\s*$" src/tools/supabase_tool.py src/agents/quote_agent.py src/api/routes.py src/services/auth_service.py 2>/dev/null || echo "No bare exceptions found"

# Verify logger.py is deleted
test ! -f src/utils/logger.py && echo "logger.py deleted successfully"
```
  </verify>
  <done>All remaining bare exceptions fixed and unused logger.py deleted</done>
</task>

</tasks>

<verification>
1. Verify no bare exceptions remain in the codebase:
   ```bash
   grep -rn "except:\s*$" src/ --include="*.py" | wc -l
   # Should return 0
   ```

2. Verify logger.py is deleted:
   ```bash
   test ! -f src/utils/logger.py && echo "PASS: logger.py deleted"
   ```

3. Run tests to ensure no regressions:
   ```bash
   pytest tests/test_email_webhook.py tests/test_analytics_routes.py -v
   ```

4. Verify imports still work:
   ```bash
   python -c "
   from src.webhooks.email_webhook import router
   from src.api.analytics_routes import analytics_router
   print('All imports OK')
   "
   ```
</verification>

<success_criteria>
- 0 bare `except:` clauses remain in src/ directory
- All exception handlers log with appropriate level (debug for expected failures, warning for unexpected)
- src/utils/logger.py is deleted
- Existing tests pass
- Application imports without errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-error-handling-resilience/17-02-SUMMARY.md`
</output>
