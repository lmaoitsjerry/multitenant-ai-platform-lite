---
phase: 12-devops-tests
plan: 07
type: execute
wave: 4
depends_on: ["12-05", "12-06"]
files_modified:
  - tests/test_pricing_routes.py
  - tests/test_knowledge_routes.py
  - tests/test_crm_service.py
autonomous: true

must_haves:
  truths:
    - "Pricing routes have endpoint tests"
    - "Knowledge routes have endpoint tests"
    - "CRM service has unit tests"
    - "Coverage increases by at least 7%"
  artifacts:
    - path: "tests/test_pricing_routes.py"
      provides: "Pricing endpoint tests"
      min_lines: 120
    - path: "tests/test_knowledge_routes.py"
      provides: "Knowledge endpoint tests"
      min_lines: 120
    - path: "tests/test_crm_service.py"
      provides: "CRM service tests"
      min_lines: 100
  key_links:
    - from: "tests/test_pricing_routes.py"
      to: "src/api/pricing_routes.py"
      via: "TestClient"
      pattern: "TestClient"
---

<objective>
Add tests for pricing, knowledge, and CRM functionality.

Purpose: Pricing routes (396 lines, 21%), knowledge routes (385 lines, 18%), and CRM service (213 lines, 13%) are medium-priority areas. Testing adds ~7% coverage.

Output: 340+ lines of tests.
</objective>

<context>
@.planning/STATE.md
@src/api/pricing_routes.py
@src/api/knowledge_routes.py
@src/services/crm_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pricing routes tests</name>
  <files>tests/test_pricing_routes.py</files>
  <action>
Create tests for pricing endpoints.

Key endpoints:
- GET /api/v1/pricing/rates (get rates)
- POST /api/v1/pricing/rates (update rates)
- GET /api/v1/pricing/categories (categories)
- POST /api/v1/pricing/calculate (calculate price)

Mock dependencies. Test rate calculations, category filtering.
Target: 120+ lines.
  </action>
  <verify>
pytest tests/test_pricing_routes.py -v
  </verify>
  <done>
test_pricing_routes.py created.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create knowledge routes tests</name>
  <files>tests/test_knowledge_routes.py</files>
  <action>
Create tests for knowledge base endpoints.

Key endpoints:
- GET /api/v1/knowledge (list documents)
- POST /api/v1/knowledge (upload document)
- DELETE /api/v1/knowledge/{id} (delete)
- POST /api/v1/knowledge/search (search)

Mock storage and FAISS. Test CRUD operations.
Target: 120+ lines.
  </action>
  <verify>
pytest tests/test_knowledge_routes.py -v
  </verify>
  <done>
test_knowledge_routes.py created.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create CRM service tests</name>
  <files>tests/test_crm_service.py</files>
  <action>
Create tests for CRMService methods.

Key methods:
- get_clients
- get_client_by_id
- create_client
- update_client
- get_pipeline_stages
- move_client_stage

Mock Supabase. Test CRUD and pipeline operations.
Target: 100+ lines.
  </action>
  <verify>
pytest tests/test_crm_service.py -v
  </verify>
  <done>
test_crm_service.py created.
  </done>
</task>

</tasks>

<verification>
- [ ] All test files created with target line counts
- [ ] All tests pass
- [ ] Coverage increases
</verification>

<success_criteria>
1. Pricing, knowledge, and CRM have tests
2. All tests pass
3. Approaching 70% coverage target
</success_criteria>

<output>
After completion, create `.planning/phases/12-devops-tests/12-07-SUMMARY.md`
</output>
