---
phase: 12-devops-tests
plan: 13
type: execute
wave: 7
depends_on: ["12-11", "12-12"]
files_modified:
  - tests/test_leaderboard_routes.py
  - tests/test_middleware_integration.py
  - tests/test_quote_agent.py
  - pyproject.toml
  - .github/workflows/ci.yml
autonomous: true

must_haves:
  truths:
    - "All remaining low-coverage files have tests"
    - "Coverage reaches 70%"
    - "CI threshold set to 70%"
  artifacts:
    - path: "pyproject.toml"
      provides: "Coverage config"
      contains: "fail_under = 70"
    - path: ".github/workflows/ci.yml"
      provides: "CI workflow"
      contains: "cov-fail-under=70"
---

<objective>
Final push to 70% coverage. Test remaining areas and update CI threshold.

Purpose: Complete TEST-04 requirement by reaching 70% coverage and enforcing it in CI.

Output: Final tests, 70% threshold enforced.
</objective>

<context>
@.planning/STATE.md
@pyproject.toml
@.github/workflows/ci.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create remaining route tests</name>
  <files>tests/test_leaderboard_routes.py</files>
  <action>
Create tests for leaderboard routes (117 lines, 0% coverage).

Key endpoints:
- GET /api/v1/leaderboard
- GET /api/v1/leaderboard/agents

Target: 100+ lines.
  </action>
  <verify>
pytest tests/test_leaderboard_routes.py -v
  </verify>
  <done>
test_leaderboard_routes.py created.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create middleware integration tests</name>
  <files>tests/test_middleware_integration.py</files>
  <action>
Create integration tests that verify all middleware works together.

Test scenarios:
- Request with valid auth + rate limit
- Request with invalid auth
- Request hitting rate limit
- Security headers on responses
- Request ID propagation

Target: 150+ lines.
  </action>
  <verify>
pytest tests/test_middleware_integration.py -v
  </verify>
  <done>
test_middleware_integration.py created.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create quote agent tests</name>
  <files>tests/test_quote_agent.py</files>
  <action>
Create tests for QuoteAgent (AI quote generation).

Key methods:
- generate_quote
- process_request
- format_response

Mock OpenAI client. Target: 150+ lines.
  </action>
  <verify>
pytest tests/test_quote_agent.py -v
  </verify>
  <done>
test_quote_agent.py created.
  </done>
</task>

<task type="auto">
  <name>Task 4: Verify and set 70% threshold</name>
  <files>pyproject.toml, .github/workflows/ci.yml</files>
  <action>
1. Run full test suite with coverage
2. If coverage >= 70%, update thresholds
3. If coverage < 70%, identify remaining gaps

Update both files:
- pyproject.toml: fail_under = 70
- ci.yml: --cov-fail-under=70
  </action>
  <verify>
pytest tests/ --cov=src --cov=main --cov=config --cov-fail-under=70
  </verify>
  <done>
Coverage threshold set to 70%, tests pass.
  </done>
</task>

</tasks>

<verification>
- [ ] All test files created
- [ ] Coverage >= 70%
- [ ] pyproject.toml has fail_under = 70
- [ ] ci.yml has cov-fail-under=70
- [ ] Full test suite passes
</verification>

<success_criteria>
1. TEST-04 requirement fully satisfied
2. 70% coverage achieved and enforced
3. Phase 12 complete
</success_criteria>

<output>
After completion, create `.planning/phases/12-devops-tests/12-13-SUMMARY.md`
</output>
