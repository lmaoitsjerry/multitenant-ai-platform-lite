---
phase: 12-devops-tests
plan: 09
type: execute
wave: 5
depends_on: ["12-07"]
files_modified:
  - tests/test_email_sender.py
  - tests/test_pdf_generator.py
  - tests/test_email_webhook.py
autonomous: true

must_haves:
  truths:
    - "Email sender has comprehensive mocked tests"
    - "PDF generator has unit tests"
    - "Email webhook has endpoint tests"
    - "Coverage increases by at least 8%"
  artifacts:
    - path: "tests/test_email_sender.py"
      provides: "Email sender tests"
      min_lines: 200
    - path: "tests/test_pdf_generator.py"
      provides: "PDF generator tests"
      min_lines: 200
    - path: "tests/test_email_webhook.py"
      provides: "Email webhook tests"
      min_lines: 150
---

<objective>
Add tests for external integrations: email sender, PDF generation, email webhook.

Purpose: These three areas account for ~800 uncovered lines. Mock external APIs (SendGrid, weasyprint) to test business logic without network calls.

Output: 550+ lines of tests, ~8% coverage increase.
</objective>

<context>
@.planning/STATE.md
@src/utils/email_sender.py
@src/utils/pdf_generator.py
@src/webhooks/email_webhook.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email sender tests</name>
  <files>tests/test_email_sender.py</files>
  <action>
Create tests for EmailSender class. Mock SendGrid client.

Key methods to test:
- send_email (basic email)
- send_quote_email (quote PDF attachment)
- send_invoice_email (invoice PDF attachment)
- send_notification (status updates)

Mock:
- sendgrid.SendGridAPIClient
- All network calls

Test:
- Email construction (to, from, subject, body)
- Attachment handling
- Error handling (API failures)
- Template rendering

Target: 200+ lines.
  </action>
  <verify>
pytest tests/test_email_sender.py -v
  </verify>
  <done>
test_email_sender.py created with mocked SendGrid tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PDF generator tests</name>
  <files>tests/test_pdf_generator.py</files>
  <action>
Create tests for PDFGenerator class. Mock weasyprint.

Key methods to test:
- generate_quote_pdf
- generate_invoice_pdf
- render_template
- _format_currency
- _format_date

Mock:
- weasyprint.HTML.write_pdf
- File operations

Test:
- Template data population
- Currency formatting
- Date formatting
- Error handling

Target: 200+ lines.
  </action>
  <verify>
pytest tests/test_pdf_generator.py -v
  </verify>
  <done>
test_pdf_generator.py created with mocked weasyprint tests.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create email webhook tests</name>
  <files>tests/test_email_webhook.py</files>
  <action>
Create tests for email webhook handler (inbound email processing).

Key functions to test:
- process_inbound_email
- parse_email_content
- extract_sender_info
- route_to_tenant

Mock:
- SupabaseTool
- QuoteAgent

Test:
- Email parsing
- Tenant routing
- Quote generation trigger
- Error handling

Target: 150+ lines.
  </action>
  <verify>
pytest tests/test_email_webhook.py -v
  </verify>
  <done>
test_email_webhook.py created with inbound email tests.
  </done>
</task>

</tasks>

<verification>
- [ ] All test files created with target line counts
- [ ] All tests pass
- [ ] Coverage increases by 8%+
</verification>

<success_criteria>
1. External integrations have mocked tests
2. All tests pass
3. Coverage approaches 42%
</success_criteria>

<output>
After completion, create `.planning/phases/12-devops-tests/12-09-SUMMARY.md`
</output>
