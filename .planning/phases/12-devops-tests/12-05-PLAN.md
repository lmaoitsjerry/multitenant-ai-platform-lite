---
phase: 12-devops-tests
plan: 05
type: execute
wave: 3
depends_on: ["12-04"]
files_modified:
  - tests/test_supabase_tool.py
  - tests/test_core_routes.py
autonomous: true

must_haves:
  truths:
    - "SupabaseTool methods have unit tests"
    - "Core API routes have endpoint tests"
    - "Coverage increases by at least 10%"
  artifacts:
    - path: "tests/test_supabase_tool.py"
      provides: "SupabaseTool unit tests"
      min_lines: 200
    - path: "tests/test_core_routes.py"
      provides: "Core routes tests"
      min_lines: 200
  key_links:
    - from: "tests/test_supabase_tool.py"
      to: "src/tools/supabase_tool.py"
      via: "import"
      pattern: "from src.tools.supabase_tool"
---

<objective>
Add tests for highest-impact uncovered code: SupabaseTool and core routes.

Purpose: These two areas account for ~9% potential coverage gain. SupabaseTool is the database abstraction layer used everywhere. Core routes handle quotes, invoices, clients - critical business logic.

Output: 400+ lines of tests, ~10% coverage increase.
</objective>

<context>
@.planning/STATE.md
@src/tools/supabase_tool.py
@src/api/routes.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SupabaseTool tests</name>
  <files>tests/test_supabase_tool.py</files>
  <action>
Create comprehensive tests for SupabaseTool methods. Mock the Supabase client.

Key methods to test:
- get_client_data (tenant isolation)
- get_quotes (list with pagination)
- get_quote_by_id (single record)
- create_quote (insert)
- update_quote (update)
- get_invoices (list)
- get_clients (CRM data)
- get_pipeline (CRM pipeline)
- get_tenant_settings
- update_tenant_settings

Use pytest fixtures for mock Supabase client. Test:
- Success cases
- Error handling
- Tenant isolation (client_id filtering)

Target: 200+ lines, test all major CRUD operations.
  </action>
  <verify>
pytest tests/test_supabase_tool.py -v
All tests should pass.
  </verify>
  <done>
test_supabase_tool.py created with tests for major SupabaseTool methods.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create core routes tests</name>
  <files>tests/test_core_routes.py</files>
  <action>
Create tests for core business routes in src/api/routes.py.

Key endpoints to test:
- GET /api/v1/quotes (list quotes)
- GET /api/v1/quotes/{id} (get quote)
- POST /api/v1/quotes (create quote)
- GET /api/v1/invoices (list invoices)
- GET /api/v1/invoices/{id} (get invoice)
- GET /api/v1/clients (list clients)
- GET /api/v1/pipeline (CRM pipeline)

Use TestClient with mocked dependencies (SupabaseTool, AuthService).
Test both authenticated and unauthenticated access.

Target: 200+ lines covering critical business endpoints.
  </action>
  <verify>
pytest tests/test_core_routes.py -v
All tests should pass.
  </verify>
  <done>
test_core_routes.py created with tests for core business endpoints.
  </done>
</task>

</tasks>

<verification>
- [ ] test_supabase_tool.py exists with 200+ lines
- [ ] test_core_routes.py exists with 200+ lines
- [ ] All new tests pass
- [ ] Coverage increases by at least 5%
</verification>

<success_criteria>
1. SupabaseTool has comprehensive unit tests
2. Core routes have endpoint tests
3. All tests pass
4. Coverage increases meaningfully
</success_criteria>

<output>
After completion, create `.planning/phases/12-devops-tests/12-05-SUMMARY.md`
</output>
