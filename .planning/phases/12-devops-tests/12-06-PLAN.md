---
phase: 12-devops-tests
plan: 06
type: execute
wave: 3
depends_on: ["12-04"]
files_modified:
  - tests/test_analytics_routes.py
  - tests/test_helpdesk_service.py
autonomous: true

must_haves:
  truths:
    - "Analytics routes have endpoint tests"
    - "FAISS helpdesk service has unit tests"
    - "Coverage increases by at least 5%"
  artifacts:
    - path: "tests/test_analytics_routes.py"
      provides: "Analytics endpoint tests"
      min_lines: 150
    - path: "tests/test_helpdesk_service.py"
      provides: "Helpdesk service tests"
      min_lines: 150
  key_links:
    - from: "tests/test_analytics_routes.py"
      to: "src/api/analytics_routes.py"
      via: "TestClient"
      pattern: "TestClient"
---

<objective>
Add tests for analytics routes and helpdesk service.

Purpose: Analytics routes (553 lines, 6% coverage) and FAISS helpdesk (293 lines, 14% coverage) are large uncovered areas. Testing them adds ~7% coverage potential.

Output: 300+ lines of tests, ~7% coverage increase.
</objective>

<context>
@.planning/STATE.md
@src/api/analytics_routes.py
@src/services/faiss_helpdesk_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics routes tests</name>
  <files>tests/test_analytics_routes.py</files>
  <action>
Create tests for analytics endpoints.

Key endpoints to test:
- GET /api/v1/analytics/dashboard (dashboard summary)
- GET /api/v1/analytics/revenue (revenue metrics)
- GET /api/v1/analytics/quotes (quote metrics)
- GET /api/v1/analytics/conversion (conversion rates)

Mock SupabaseTool and BigQueryTool. Test:
- Authenticated access required
- Date range filtering
- Response structure validation

Target: 150+ lines.
  </action>
  <verify>
pytest tests/test_analytics_routes.py -v
All tests should pass.
  </verify>
  <done>
test_analytics_routes.py created with analytics endpoint tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create helpdesk service tests</name>
  <files>tests/test_helpdesk_service.py</files>
  <action>
Create tests for FAISSHelpdeskService.

Key methods to test:
- search_knowledge_base (RAG search)
- get_relevant_documents (document retrieval)
- classify_query (query classification)
- generate_response (response generation)

Mock FAISS index and OpenAI client. Test:
- Search returns relevant results
- Empty query handling
- Error handling for missing index

Target: 150+ lines.
  </action>
  <verify>
pytest tests/test_helpdesk_service.py -v
All tests should pass.
  </verify>
  <done>
test_helpdesk_service.py created with helpdesk service tests.
  </done>
</task>

</tasks>

<verification>
- [ ] test_analytics_routes.py exists with 150+ lines
- [ ] test_helpdesk_service.py exists with 150+ lines
- [ ] All new tests pass
- [ ] Coverage increases by at least 3%
</verification>

<success_criteria>
1. Analytics routes have endpoint tests
2. FAISS helpdesk service has unit tests
3. All tests pass
4. Coverage increases meaningfully
</success_criteria>

<output>
After completion, create `.planning/phases/12-devops-tests/12-06-SUMMARY.md`
</output>
