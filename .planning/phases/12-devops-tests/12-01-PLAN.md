---
phase: 12-devops-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dockerfile
autonomous: true

must_haves:
  truths:
    - "Container runs as non-root user (uid 1000)"
    - "Application files have correct ownership"
    - "Health check works with non-root user"
  artifacts:
    - path: "Dockerfile"
      provides: "Hardened container configuration"
      contains: "USER appuser"
  key_links:
    - from: "Dockerfile"
      to: "main.py"
      via: "CMD exec uvicorn"
      pattern: "uvicorn main:app"
---

<objective>
Harden Dockerfile to run as non-root user for production security.

Purpose: Running containers as root is a security anti-pattern. If the container is compromised, an attacker gains root access. Running as non-root limits the blast radius of any security breach.

Output: Updated Dockerfile that creates and uses a non-root user while maintaining all functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add non-root user to Dockerfile</name>
  <files>Dockerfile</files>
  <action>
Update the Dockerfile to:
1. Create a non-root user and group (appuser:appgroup, uid/gid 1000)
2. Set proper ownership of /app directory
3. Switch to non-root user before CMD
4. Keep system dependencies installation as root (required for apt-get)
5. Update health check to work without requiring root privileges

Structure:
```dockerfile
# Install system dependencies as root
RUN apt-get update && apt-get install -y ... && rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN groupadd --gid 1000 appgroup && \
    useradd --uid 1000 --gid appgroup --shell /bin/bash --create-home appuser

# Copy and install dependencies (still as root for pip)
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY --chown=appuser:appgroup . .

# Switch to non-root user
USER appuser

# Update health check (use curl instead of python import)
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

CMD exec uvicorn main:app --host 0.0.0.0 --port ${PORT}
```

Note: The health check needs `curl` - either install it with apt-get or keep the Python-based check but ensure requests is available.
  </action>
  <verify>
Run: `docker build -t test-nonroot .`
Run: `docker run --rm test-nonroot whoami` - should output "appuser", NOT "root"
Run: `docker run --rm test-nonroot id` - should show uid=1000(appuser) gid=1000(appgroup)
  </verify>
  <done>
Dockerfile builds successfully, container runs as uid 1000 (appuser), health check works, application starts normally.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify application functionality as non-root</name>
  <files>Dockerfile</files>
  <action>
Test that the application works correctly when running as non-root:
1. Build the Docker image
2. Start the container
3. Verify health endpoint responds
4. Verify application can read config files
5. Verify application can write to any necessary directories (if applicable)

If any permissions issues arise, fix them by:
- Using COPY --chown for files that need to be readable
- Creating necessary directories with proper ownership
- NOT running the application as root (that defeats the purpose)
  </action>
  <verify>
Run container and check health:
```bash
docker build -t platform-nonroot .
docker run -d --name test-container -p 8080:8080 platform-nonroot
sleep 5
curl http://localhost:8080/health
docker logs test-container
docker stop test-container && docker rm test-container
```
Health endpoint should return {"status": "healthy"}, no permission errors in logs.
  </verify>
  <done>
Container starts successfully as non-root user, health endpoint returns 200, no permission-related errors in logs, application is functional.
  </done>
</task>

</tasks>

<verification>
- [ ] `docker build .` succeeds without errors
- [ ] `docker run --rm <image> whoami` outputs "appuser"
- [ ] `docker run --rm <image> id` shows uid=1000
- [ ] Health check passes when container runs
- [ ] No permission errors in container logs
</verification>

<success_criteria>
1. Dockerfile runs as non-root user (uid 1000, not root)
2. All application functionality works (no permission errors)
3. Health check functions correctly
4. Docker build completes without warnings about running as root
</success_criteria>

<output>
After completion, create `.planning/phases/12-devops-tests/12-01-SUMMARY.md`
</output>
