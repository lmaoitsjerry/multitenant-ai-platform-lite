---
phase: 11-database-tenant-registry
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - database/migrations/012_tenant_config.sql
autonomous: true

must_haves:
  truths:
    - "Tenant configuration can be stored as JSONB in database"
    - "Migration script runs without errors on Supabase"
    - "Existing tenants table extended with tenant_config column"
  artifacts:
    - path: "database/migrations/012_tenant_config.sql"
      provides: "Schema extension for tenant_config JSONB column"
      contains: "ALTER TABLE tenants"
  key_links:
    - from: "database/migrations/012_tenant_config.sql"
      to: "database/migrations/011_tenants_registry.sql"
      via: "ALTER TABLE extends existing tenants table"
      pattern: "ALTER TABLE tenants ADD COLUMN"
---

<objective>
Extend the existing tenants registry table with a tenant_config JSONB column to store full tenant configuration.

Purpose: Enable storing complete tenant configuration (branding, destinations, infrastructure refs, email settings, consultants, agents) in the database instead of YAML files. Uses hybrid approach: core fields remain in columns, extended config in JSONB.

Output: Migration script 012_tenant_config.sql ready to run on Supabase
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@database/migrations/011_tenants_registry.sql
@config/schema.json
@clients/africastay/client.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tenant_config schema extension migration</name>
  <files>database/migrations/012_tenant_config.sql</files>
  <action>
Create migration script that:

1. ADD tenant_config JSONB column to tenants table:
   - tenant_config JSONB DEFAULT '{}'::jsonb
   - Contains: branding, destinations, infrastructure (refs only, not secrets), email (refs only), consultants, agents config

2. ADD additional columns for commonly queried fields (denormalized for performance):
   - timezone VARCHAR(50) DEFAULT 'Africa/Johannesburg'
   - currency VARCHAR(10) DEFAULT 'ZAR'
   - primary_email VARCHAR(255)
   - gcp_project_id VARCHAR(100)
   - gcp_dataset VARCHAR(100)

3. ADD config_source column to track origin:
   - config_source VARCHAR(20) DEFAULT 'database' CHECK (config_source IN ('yaml', 'database'))
   - This enables dual-mode operation during migration

4. ADD suspended_at and suspended_reason columns (if not exist):
   - suspended_at TIMESTAMPTZ
   - suspended_reason TEXT

5. CREATE GIN index on tenant_config for JSONB queries:
   - CREATE INDEX idx_tenants_config ON tenants USING GIN (tenant_config)

6. ADD comments documenting the schema

Important: Use IF NOT EXISTS / ADD COLUMN IF NOT EXISTS patterns for idempotency.

DO NOT store secrets in tenant_config:
- API keys (SendGrid, OpenAI, VAPI) should use env var references like "${TENANT_SENDGRID_KEY}"
- Supabase service keys should NOT be in tenant_config
  </action>
  <verify>
Review the SQL for:
- Proper ALTER TABLE syntax
- GIN index creation
- CHECK constraint on config_source
- No secrets stored in schema design
  </verify>
  <done>
Migration file 012_tenant_config.sql exists with:
- tenant_config JSONB column
- Denormalized query columns (timezone, currency, etc.)
- config_source tracking column
- GIN index for JSONB queries
- Idempotent (can run multiple times safely)
  </done>
</task>

<task type="auto">
  <name>Task 2: Document the tenant_config JSONB structure</name>
  <files>database/migrations/012_tenant_config.sql</files>
  <action>
Add SQL comments at the end of the migration documenting the expected tenant_config JSONB structure:

```sql
/*
tenant_config JSONB Structure:
{
  "branding": {
    "company_name": "string",
    "logo_url": "string|null",
    "primary_color": "#hex",
    "secondary_color": "#hex",
    "email_signature": "string"
  },
  "destinations": [
    {"name": "string", "code": "ABC", "enabled": true, "aliases": ["string"]}
  ],
  "infrastructure": {
    "gcp": {"region": "string", "corpus_id": "string|null"},
    "supabase": {"url": "string"},
    "vapi": {"phone_number_id": "string", "assistant_id": "string"},
    "openai": {"model": "gpt-4o-mini"}
  },
  "email": {
    "primary": "email@domain.com",
    "sendgrid": {"from_email": "string", "from_name": "string", "reply_to": "string"},
    "smtp": {"host": "string", "port": 465, "username": "string"},
    "imap": {"host": "string", "port": 993}
  },
  "banking": {
    "bank_name": "string",
    "account_name": "string",
    "account_number": "string",
    "branch_code": "string",
    "swift_code": "string",
    "reference_prefix": "XX"
  },
  "consultants": [
    {"id": "string", "name": "string", "email": "string", "active": true}
  ],
  "agents": {
    "inbound": {"enabled": true, "prompt_file": "string"},
    "helpdesk": {"enabled": true, "prompt_file": "string"},
    "outbound": {"enabled": true, "prompt_file": "string"}
  }
}

NOTE: API keys and secrets are NOT stored in tenant_config.
They are resolved at runtime from environment variables:
- SENDGRID_API_KEY or {TENANT_ID}_SENDGRID_API_KEY
- OPENAI_API_KEY (shared)
- VAPI_API_KEY or {TENANT_ID}_VAPI_API_KEY
- SUPABASE_SERVICE_KEY (shared, from env)
*/
```
  </action>
  <verify>
SQL file contains documentation comment explaining:
- Full JSONB structure
- What is NOT stored (secrets)
- How secrets are resolved at runtime
  </verify>
  <done>
Migration includes comprehensive documentation of the tenant_config structure and secret handling approach
  </done>
</task>

</tasks>

<verification>
- [ ] Migration file exists at database/migrations/012_tenant_config.sql
- [ ] SQL syntax is valid (no syntax errors)
- [ ] Migration is idempotent (uses IF NOT EXISTS patterns)
- [ ] GIN index created for tenant_config JSONB
- [ ] config_source column enables dual-mode operation
- [ ] Documentation explains structure and secret handling
</verification>

<success_criteria>
1. Migration script 012_tenant_config.sql can be run on Supabase SQL Editor
2. Script extends existing tenants table (does not create new table)
3. JSONB structure documented, secrets explicitly excluded
4. Idempotent - safe to run multiple times
</success_criteria>

<output>
After completion, create `.planning/phases/11-database-tenant-registry/11-01-SUMMARY.md`
</output>
