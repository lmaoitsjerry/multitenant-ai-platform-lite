---
phase: 13-external-api-mocks
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/fixtures/sendgrid_fixtures.py
  - tests/test_sendgrid_admin.py
  - tests/test_admin_sendgrid_routes.py
autonomous: true

must_haves:
  truths:
    - "SendGrid admin service can be mocked with realistic API responses"
    - "SendGrid template and subuser tests cover advanced scenarios"
    - "Mock fixtures are reusable across test files"
  artifacts:
    - path: "tests/fixtures/sendgrid_fixtures.py"
      provides: "Reusable SendGrid mock factory and response generators"
      min_lines: 80
    - path: "tests/test_sendgrid_admin.py"
      provides: "Comprehensive SendGridAdminService unit tests"
      min_lines: 150
    - path: "tests/test_admin_sendgrid_routes.py"
      provides: "Admin SendGrid routes endpoint tests"
      min_lines: 100
  key_links:
    - from: "tests/test_sendgrid_admin.py"
      to: "src/services/sendgrid_admin.py"
      via: "Mock SendGrid API client"
      pattern: "patch.*sendgrid"
    - from: "tests/test_admin_sendgrid_routes.py"
      to: "src/api/admin_sendgrid_routes.py"
      via: "FastAPI TestClient with mocked service"
      pattern: "client\\.get.*sendgrid"
---

<objective>
Create reusable SendGrid mock infrastructure and comprehensive tests for SendGrid admin service and routes.

Purpose: The SendGrid admin service (src/services/sendgrid_admin.py) and admin routes (src/api/admin_sendgrid_routes.py) manage subusers, email statistics, and tenant credentials. These endpoints require mocking the SendGrid API to test subuser listing, statistics retrieval, enable/disable functionality, and credential management. This plan creates mock infrastructure reusable in Phase 14 for agent tests.

Output:
- tests/fixtures/sendgrid_fixtures.py with SendGrid API response mocks
- tests/test_sendgrid_admin.py with comprehensive service tests
- tests/test_admin_sendgrid_routes.py with endpoint tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/services/sendgrid_admin.py
@src/api/admin_sendgrid_routes.py
@tests/test_email_sender.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SendGrid mock fixtures module</name>
  <files>
    tests/fixtures/sendgrid_fixtures.py
  </files>
  <action>
Create tests/fixtures/sendgrid_fixtures.py with:

1. **MockSendGridResponse class** - Simulates SendGrid API response:
   ```python
   class MockSendGridResponse:
       def __init__(self, status_code: int, body: str):
           self.status_code = status_code
           self.body = body
   ```

2. **MockSendGridClient class** - Simulates SendGrid API client:
   - `self.client.subusers.get()` - Returns list of subusers
   - `self.client.subusers._(username).stats.get(query_params=...)` - Returns stats
   - `self.client.subusers._(username).patch(request_body=...)` - Enable/disable
   - `self.client.stats.get(query_params=...)` - Global stats
   - Uses fluent interface pattern for method chaining

3. **Data generators** - Factory functions for realistic test data:
   ```python
   def generate_subusers(n=3):
       """Generate list of subuser dictionaries."""
       return [
           {"username": f"tenant_{i}", "email": f"tenant{i}@example.com", "disabled": False, "id": i}
           for i in range(n)
       ]

   def generate_subuser_stats(username: str, days: int = 30):
       """Generate daily stats response for a subuser."""
       # Returns structure matching SendGrid API format with date, metrics
       ...

   def generate_global_stats(days: int = 30):
       """Generate platform-wide email statistics."""
       # Returns aggregated metrics: requests, delivered, opens, bounces, etc.
       ...
   ```

4. **Fixture factory function**:
   ```python
   def create_mock_sendgrid_service(available: bool = True, subusers: list = None):
       """Create a configured SendGridAdminService mock."""
       mock_service = MagicMock()
       mock_service.is_available.return_value = available
       if subusers:
           mock_service.list_subusers.return_value = subusers
       return mock_service
   ```

5. **API response templates**:
   - `SUBUSER_LIST_RESPONSE` - JSON template for subuser list
   - `SUBUSER_STATS_RESPONSE` - JSON template with daily metrics
   - `GLOBAL_STATS_RESPONSE` - JSON template for platform stats
  </action>
  <verify>
Run `python -c "from tests.fixtures.sendgrid_fixtures import create_mock_sendgrid_service, generate_subusers; print('Import successful')"` to verify module loads.
  </verify>
  <done>
SendGrid mock fixtures module exists at tests/fixtures/sendgrid_fixtures.py with MockSendGridClient class, data generators, and factory function.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SendGridAdminService unit tests</name>
  <files>tests/test_sendgrid_admin.py</files>
  <action>
Create tests/test_sendgrid_admin.py with comprehensive tests for src/services/sendgrid_admin.py:

1. **TestSendGridAdminServiceInit** class:
   - `test_init_with_api_key` - Set SENDGRID_API_KEY env, verify is_available=True
   - `test_init_without_api_key` - No env var, verify is_available=False
   - `test_init_handles_import_error` - Mock sendgrid import failure, verify graceful handling
   - `test_init_handles_client_error` - Mock SendGridAPIClient raises, verify is_available=False

2. **TestListSubusers** class:
   - `test_list_subusers_success` - Mock 200 response, verify subuser list returned
   - `test_list_subusers_empty` - Mock 200 with empty list, verify [] returned
   - `test_list_subusers_not_available` - is_available=False, verify [] returned
   - `test_list_subusers_api_error` - Mock non-200 status, verify [] returned
   - `test_list_subusers_exception` - Mock raises Exception, verify [] returned

3. **TestGetSubuserStats** class:
   - `test_get_subuser_stats_success` - Mock stats response, verify totals calculated
   - `test_get_subuser_stats_calculates_rates` - Verify open_rate, click_rate, bounce_rate calculations
   - `test_get_subuser_stats_handles_zero_delivered` - Zero delivered, verify rates=0 not division error
   - `test_get_subuser_stats_not_available` - Service unavailable, verify error dict returned
   - `test_get_subuser_stats_api_error` - Mock 404 for unknown user, verify error dict
   - `test_get_subuser_stats_aggregates_daily` - Multiple days, verify totals summed correctly

4. **TestGetGlobalStats** class:
   - `test_get_global_stats_success` - Mock response, verify totals
   - `test_get_global_stats_calculates_delivery_rate` - Verify delivery_rate calculation
   - `test_get_global_stats_handles_zero_requests` - Zero requests, verify rates=0
   - `test_get_global_stats_not_available` - Service unavailable, verify error dict

5. **TestDisableSubuser** class:
   - `test_disable_subuser_success` - Mock 200/204, verify returns True
   - `test_disable_subuser_not_available` - Service unavailable, verify returns False
   - `test_disable_subuser_api_error` - Mock 400, verify returns False
   - `test_disable_subuser_exception` - Mock raises, verify returns False

6. **TestEnableSubuser** class:
   - `test_enable_subuser_success` - Mock 200/204, verify returns True
   - `test_enable_subuser_not_available` - Service unavailable, verify returns False
   - `test_enable_subuser_api_error` - Mock 400, verify returns False

7. **TestSingleton** class:
   - `test_get_sendgrid_admin_service_returns_singleton` - Call twice, verify same instance
   - `test_singleton_can_be_reset` - Reset _sendgrid_admin_service, verify new instance

Mock pattern for SendGrid client:
```python
@patch.dict(os.environ, {'SENDGRID_API_KEY': 'SG.test-key'})
@patch('src.services.sendgrid_admin.sendgrid')
def test_example(self, mock_sendgrid_module):
    mock_client = MagicMock()
    mock_response = MockSendGridResponse(200, json.dumps([...]))
    mock_client.client.subusers.get.return_value = mock_response
    mock_sendgrid_module.SendGridAPIClient.return_value = mock_client

    from src.services.sendgrid_admin import SendGridAdminService
    service = SendGridAdminService()
    result = service.list_subusers()
```
  </action>
  <verify>
Run `pytest tests/test_sendgrid_admin.py -v --cov=src/services/sendgrid_admin --cov-report=term-missing` to verify tests pass and coverage.
  </verify>
  <done>
test_sendgrid_admin.py has 20+ tests covering all methods of SendGridAdminService with mocked SendGrid API responses.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create admin SendGrid routes endpoint tests</name>
  <files>tests/test_admin_sendgrid_routes.py</files>
  <action>
Create tests/test_admin_sendgrid_routes.py with endpoint tests for src/api/admin_sendgrid_routes.py:

1. **TestAdminSendGridAuth** class:
   - `test_list_subusers_requires_admin_token` - No header, verify 401/503
   - `test_subuser_stats_requires_admin_token` - No header, verify 401/503
   - `test_disable_subuser_requires_admin_token` - No header, verify 401/503
   - `test_enable_subuser_requires_admin_token` - No header, verify 401/503
   - `test_global_stats_requires_admin_token` - No header, verify 401/503
   - `test_store_credentials_requires_admin_token` - No header, verify 401/503

2. **TestListSubusersEndpoint** class:
   - `test_list_subusers_success` - Mock service, verify response format
   - `test_list_subusers_with_tenant_matching` - Mock subusers matching tenant IDs, verify enrichment
   - `test_list_subusers_sendgrid_not_configured` - Mock is_available=False, verify message

3. **TestSubuserStatsEndpoint** class:
   - `test_get_subuser_stats_success` - Mock stats, verify response
   - `test_get_subuser_stats_with_days_param` - Query param days=7, verify passed to service
   - `test_get_subuser_stats_service_unavailable` - Mock unavailable, verify 503
   - `test_get_subuser_stats_error` - Mock error dict, verify 400

4. **TestSubuserEnableDisableEndpoint** class:
   - `test_disable_subuser_success` - Mock returns True, verify response
   - `test_disable_subuser_failure` - Mock returns False, verify 400
   - `test_enable_subuser_success` - Mock returns True, verify response
   - `test_enable_subuser_failure` - Mock returns False, verify 400

5. **TestGlobalStatsEndpoint** class:
   - `test_global_stats_success` - Mock stats, verify response
   - `test_global_stats_not_configured` - Mock unavailable, verify default zeros

6. **TestTenantCredentialsEndpoints** class:
   - `test_store_credentials_success` - Mock tenant exists, verify stored
   - `test_store_credentials_tenant_not_found` - Invalid tenant, verify 404
   - `test_get_credentials_success` - Mock settings exist, verify response (no API key exposed)
   - `test_get_credentials_tenant_not_found` - Invalid tenant, verify 404
   - `test_delete_credentials_success` - Mock update succeeds, verify response
   - `test_delete_credentials_tenant_not_found` - Invalid tenant, verify 404

7. **TestPydanticModels** class:
   - `test_subuser_info_model` - Verify SubuserInfo model validation
   - `test_subuser_stats_model` - Verify SubuserStats model
   - `test_global_email_stats_model` - Verify GlobalEmailStats model
   - `test_subuser_credentials_model` - Verify SubuserCredentials model

Mock pattern for admin auth:
```python
@patch('src.api.admin_sendgrid_routes.verify_admin_token')
@patch('src.api.admin_sendgrid_routes.get_sendgrid_admin_service')
def test_example(self, mock_get_service, mock_verify):
    mock_verify.return_value = True
    mock_service = MagicMock()
    mock_service.is_available.return_value = True
    mock_service.list_subusers.return_value = [...]
    mock_get_service.return_value = mock_service

    client = TestClient(app)
    response = client.get(
        "/api/v1/admin/sendgrid/subusers",
        headers={"X-Admin-Token": "test-token"}
    )
```
  </action>
  <verify>
Run `pytest tests/test_admin_sendgrid_routes.py -v --cov=src/api/admin_sendgrid_routes --cov-report=term-missing` to verify tests pass and coverage.
  </verify>
  <done>
test_admin_sendgrid_routes.py has 20+ tests covering all admin SendGrid endpoints with mocked service and auth.
  </done>
</task>

</tasks>

<verification>
1. Run SendGrid service tests: `pytest tests/test_sendgrid_admin.py -v`
2. Run SendGrid routes tests: `pytest tests/test_admin_sendgrid_routes.py -v`
3. Check combined coverage: `pytest tests/test_sendgrid_admin.py tests/test_admin_sendgrid_routes.py --cov=src/services/sendgrid_admin --cov=src/api/admin_sendgrid_routes --cov-report=term-missing`
4. Verify fixtures are reusable: `python -c "from tests.fixtures.sendgrid_fixtures import *; print('Fixtures importable')"`
</verification>

<success_criteria>
- All new tests pass
- SendGridAdminService has comprehensive coverage (70%+)
- Admin SendGrid routes have comprehensive coverage (70%+)
- SendGrid mock fixtures are reusable (importable from tests/fixtures/)
- No regressions in existing tests (test_email_sender.py still passes)
</success_criteria>

<output>
After completion, create `.planning/phases/13-external-api-mocks/13-02-SUMMARY.md`
</output>
