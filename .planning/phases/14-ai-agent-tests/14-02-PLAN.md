---
phase: 14-ai-agent-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/fixtures/genai_fixtures.py
  - tests/test_inbound_agent.py
autonomous: true

must_haves:
  truths:
    - "Inbound agent tests cover email parsing pipeline"
    - "Google GenAI (Gemini) responses can be mocked"
    - "RAG knowledge base integration is testable"
    - "Customer info extraction logic is verified"
  artifacts:
    - path: "tests/fixtures/genai_fixtures.py"
      provides: "Google GenAI mock infrastructure"
      exports: ["MockGenAIClient", "MockGenAIResponse", "create_mock_genai_client"]
    - path: "tests/test_inbound_agent.py"
      provides: "Inbound agent test coverage"
      min_lines: 200
  key_links:
    - from: "tests/test_inbound_agent.py"
      to: "src/agents/inbound_agent.py"
      via: "import and mock GenAI client"
      pattern: "patch.*genai"
---

<objective>
Create Google GenAI mock infrastructure and comprehensive tests for the inbound agent email processing pipeline.

Purpose: The inbound agent handles customer-facing conversations using Gemini for NLU, integrates with a RAG knowledge base, and extracts travel requirements from messages. All paths need deterministic test coverage.

Output: GenAI mock fixtures + inbound agent tests achieving 50%+ coverage (from current 0%)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@tests/fixtures/bigquery_fixtures.py (pattern reference)
@tests/fixtures/sendgrid_fixtures.py (pattern reference)
@src/agents/inbound_agent.py (module to test)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Google GenAI mock infrastructure</name>
  <files>tests/fixtures/genai_fixtures.py</files>
  <action>
Create reusable Google GenAI (Gemini) mock classes:

1. **MockGenAIResponse** class:
   - Simulates `response` from `client.models.generate_content()`
   - Attributes: `text` (the generated content string)
   - Optional: `candidates`, `prompt_feedback` for advanced scenarios

2. **MockGenAIModel** class:
   - Supports `generate_content(contents: str)` method
   - Pattern-based response matching on input content
   - Default response if no pattern matches

3. **MockGenAIModels** class:
   - Simulates `client.models` namespace
   - Has `generate_content(model: str, contents: str)` method
   - Delegates to MockGenAIModel

4. **MockGenAIClient** class:
   - Simulates `genai.Client(vertexai=True, project=..., location=...)`
   - Attribute: `models` (MockGenAIModels instance)
   - Method: `set_response_for_pattern(pattern: str, response_text: str)`

5. Factory function: `create_mock_genai_client(responses: Dict[str, str] = None)`

6. Helper generators:
   - `create_travel_inquiry_response(destination: str)` - Response for destination queries
   - `create_quote_ready_response(info: dict)` - Response when quote info is complete
   - `create_clarification_response(missing_field: str)` - Response asking for more info

Include docstrings and usage examples.
  </action>
  <verify>
```bash
python -c "from tests.fixtures.genai_fixtures import MockGenAIClient, create_mock_genai_client; print('GenAI fixtures import OK')"
```
  </verify>
  <done>Google GenAI mock infrastructure exists and is importable</done>
</task>

<task type="auto">
  <name>Task 2: Create inbound agent tests</name>
  <files>tests/test_inbound_agent.py</files>
  <action>
Create comprehensive tests for `src/agents/inbound_agent.py` using GenAI fixtures.

**Test classes to implement:**

1. **TestKnowledgeBaseRAG**:
   - `test_init_with_client_id` - RAG initializes with correct paths
   - `test_load_index_missing_files` - Returns False when index files don't exist
   - `test_load_index_success` - Loads FAISS index and chunks (mock faiss.read_index)
   - `test_search_no_index` - Returns empty when index not loaded
   - `test_search_with_results` - Returns matched chunks with scores
   - `test_search_filters_by_visibility` - Only returns public docs for inbound
   - `test_search_respects_min_score` - Filters low-score results

2. **TestInboundAgentInit**:
   - `test_init_with_config` - Initializes with ClientConfig and session_id
   - `test_init_creates_rag` - RAG instance created with config.client_id
   - `test_init_genai_client_success` - GenAI client created when available
   - `test_init_genai_client_failure` - Handles GenAI init errors gracefully
   - `test_build_system_prompt` - Includes company name, destinations, currency

3. **TestInboundAgentChat**:
   - `test_chat_with_genai` - Normal conversation flow with GenAI
   - `test_chat_without_genai` - Fallback response when GenAI unavailable
   - `test_chat_updates_history` - Conversation history tracks messages
   - `test_chat_with_customer_info` - Pre-filled customer info is used
   - `test_chat_extracts_info` - Info extracted from messages
   - `test_chat_with_rag_context` - RAG results injected into prompt
   - `test_chat_error_handling` - Returns error response on exception

4. **TestInfoExtraction**:
   - `test_extract_destination` - Extracts destination from message
   - `test_extract_adults` - Extracts number of adults
   - `test_extract_children` - Extracts number of children
   - `test_extract_email` - Extracts email address
   - `test_extract_name_my_name_is` - Extracts name from "my name is X"
   - `test_extract_name_im` - Extracts name from "I'm X"
   - `test_extract_multiple_fields` - Extracts multiple fields from one message
   - `test_no_extraction_when_no_match` - Doesn't extract when no patterns match

5. **TestQuoteReadiness**:
   - `test_ready_for_quote_with_destination_and_email` - True when required fields present
   - `test_not_ready_missing_destination` - False without destination
   - `test_not_ready_missing_email` - False without email
   - `test_generate_quote_request` - Returns formatted quote request dict
   - `test_generate_quote_request_not_ready` - Returns None when not ready

6. **TestConversationManagement**:
   - `test_get_collected_info` - Returns copy of collected info
   - `test_set_customer_info` - Updates collected info
   - `test_get_conversation_history` - Returns copy of history

**Mocking strategy:**
- Patch `google.genai.Client` at `src.agents.inbound_agent.genai.Client`
- Patch `faiss.read_index` for RAG tests
- Patch `SentenceTransformer` for embeddings
- Mock config with destination_names, company_name, currency, timezone, gcp_project_id, gcp_region

Target: 30+ tests covering all major code paths, achieving 50%+ coverage on inbound_agent.py
  </action>
  <verify>
```bash
cd "C:\Users\jerry\Documents\multitenant-ai-platform-lite" && python -m pytest tests/test_inbound_agent.py -v --tb=short 2>&1 | head -80
```
  </verify>
  <done>All inbound agent tests pass; coverage reaches 50%+</done>
</task>

<task type="auto">
  <name>Task 3: Verify coverage and add edge case tests</name>
  <files>tests/test_inbound_agent.py</files>
  <action>
Run coverage report specifically for inbound_agent.py to verify the 50%+ target:

1. Run pytest with coverage on just the inbound agent tests
2. Check coverage percentage for src/agents/inbound_agent.py
3. If below 50%, identify uncovered lines and add targeted tests:
   - Test the default prompt when template file not found
   - Test RAG context formatting with multiple results
   - Test conversation history trimming (last 10 messages)
   - Test collected_info context injection in _chat_genai

Add any additional tests needed to cross the 50% threshold.
  </action>
  <verify>
```bash
cd "C:\Users\jerry\Documents\multitenant-ai-platform-lite" && python -m pytest tests/test_inbound_agent.py --cov=src/agents/inbound_agent --cov-report=term-missing 2>&1 | tail -30
```
  </verify>
  <done>Coverage report shows src/agents/inbound_agent.py at 50%+ coverage</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `python -c "from tests.fixtures.genai_fixtures import *"` imports without error
2. `pytest tests/test_inbound_agent.py -v` shows 30+ tests passing
3. Coverage report shows inbound_agent.py at 50%+
</verification>

<success_criteria>
- Google GenAI mock fixtures module created with documented classes
- Inbound agent tests achieve 50%+ coverage (from 0%)
- Info extraction logic fully tested (destination, adults, children, email, name)
- RAG integration paths tested
- All tests pass without making real API calls
</success_criteria>

<output>
After completion, create `.planning/phases/14-ai-agent-tests/14-02-SUMMARY.md`
</output>
