---
phase: 14-ai-agent-tests
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/fixtures/twilio_vapi_fixtures.py
  - tests/test_twilio_vapi_provisioner.py
autonomous: true

must_haves:
  truths:
    - "Twilio API responses can be mocked"
    - "VAPI API responses can be mocked"
    - "Phone provisioning workflow is testable end-to-end"
    - "Address registration for regulatory compliance is tested"
  artifacts:
    - path: "tests/fixtures/twilio_vapi_fixtures.py"
      provides: "Twilio and VAPI mock infrastructure"
      exports: ["MockTwilioResponse", "MockVAPIResponse", "create_mock_provisioner"]
    - path: "tests/test_twilio_vapi_provisioner.py"
      provides: "Twilio VAPI provisioner test coverage"
      min_lines: 250
  key_links:
    - from: "tests/test_twilio_vapi_provisioner.py"
      to: "src/tools/twilio_vapi_provisioner.py"
      via: "patch requests.get/post/patch"
      pattern: "patch.*requests"
---

<objective>
Create Twilio/VAPI mock infrastructure and comprehensive tests for the phone provisioning service.

Purpose: The TwilioVAPIProvisioner automates phone number search, purchase, VAPI import, and assistant assignment. It also handles address registration for regulatory compliance. All external API interactions need mocking for deterministic tests.

Output: Twilio/VAPI mock fixtures + provisioner tests achieving 50%+ coverage (from current 0%)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@tests/fixtures/sendgrid_fixtures.py (pattern reference for API mocking)
@src/tools/twilio_vapi_provisioner.py (module to test)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Twilio/VAPI mock infrastructure</name>
  <files>tests/fixtures/twilio_vapi_fixtures.py</files>
  <action>
Create reusable mock classes for Twilio and VAPI API interactions:

1. **MockHTTPResponse** class:
   - Simulates `requests.Response` object
   - Attributes: `status_code`, `text`, `json()` method
   - Constructor: `MockHTTPResponse(status_code: int, data: dict = None)`

2. **TwilioResponseFactory** class with static methods:
   - `available_numbers(numbers: List[dict])` - Search results response
   - `purchase_success(phone_number: str, sid: str)` - Successful purchase
   - `purchase_error(error_message: str)` - Failed purchase
   - `list_numbers(numbers: List[dict])` - List account numbers
   - `register_address_success(sid: str)` - Address registration success
   - `list_addresses(addresses: List[dict])` - List registered addresses
   - `pricing_info(country: str)` - Country pricing response

3. **VAPIResponseFactory** class with static methods:
   - `import_success(vapi_id: str, number: str)` - Successful import
   - `import_error(error_message: str)` - Failed import
   - `assign_success(data: dict)` - Successful assistant assignment
   - `assign_error(error_message: str)` - Failed assignment

4. **Data generators**:
   - `generate_available_numbers(n: int, country_code: str)` - List of available numbers
   - `generate_twilio_number(phone: str, sid: str)` - Single number record
   - `generate_address(sid: str, country: str, city: str)` - Address record

5. Factory function: `create_mock_provisioner(twilio_responses: dict, vapi_responses: dict)`
   - Returns configured TwilioVAPIProvisioner with mocked requests

6. **MockRequestsSession** class:
   - Pattern-based response matching for requests.get/post/patch
   - Matches on URL patterns
   - Configurable responses per endpoint

Include docstrings with usage examples.
  </action>
  <verify>
```bash
python -c "from tests.fixtures.twilio_vapi_fixtures import MockHTTPResponse, TwilioResponseFactory, VAPIResponseFactory, generate_available_numbers; print('Twilio/VAPI fixtures import OK')"
```
  </verify>
  <done>Twilio/VAPI mock infrastructure exists and is importable</done>
</task>

<task type="auto">
  <name>Task 2: Create Twilio VAPI provisioner tests</name>
  <files>tests/test_twilio_vapi_provisioner.py</files>
  <action>
Create comprehensive tests for `src/tools/twilio_vapi_provisioner.py`:

**Test classes to implement:**

1. **TestTwilioVAPIProvisionerInit**:
   - `test_init_with_credentials` - Initializes with SID, token, API key
   - `test_twilio_auth_header_created` - Basic auth header is base64 encoded
   - `test_twilio_headers` - Returns correct Content-Type and auth header
   - `test_vapi_headers` - Returns correct Bearer token and Content-Type
   - `test_country_codes_mapping` - COUNTRY_CODES dict has expected entries

2. **TestSearchAvailableNumbers**:
   - `test_search_numbers_success` - Returns formatted number list
   - `test_search_numbers_with_area_code` - Area code param passed correctly
   - `test_search_numbers_with_contains` - Contains param passed correctly
   - `test_search_numbers_empty_result` - Returns empty list when none available
   - `test_search_numbers_api_error` - Returns empty list on API error
   - `test_search_numbers_timeout` - Handles timeout gracefully

3. **TestBuyTwilioNumber**:
   - `test_buy_number_success` - Returns success with SID
   - `test_buy_number_failure` - Returns error on API failure
   - `test_buy_number_exception` - Handles exceptions gracefully

4. **TestListTwilioNumbers**:
   - `test_list_numbers_success` - Returns formatted number list
   - `test_list_numbers_empty` - Returns empty list when no numbers
   - `test_list_numbers_error` - Returns empty list on API error

5. **TestImportToVAPI**:
   - `test_import_success` - Returns success with VAPI ID
   - `test_import_with_assistant` - Includes assistantId in payload
   - `test_import_with_client_id` - Includes serverUrl for webhook routing
   - `test_import_with_name` - Includes name in payload
   - `test_import_failure` - Returns error on API failure
   - `test_import_exception` - Handles exceptions gracefully

6. **TestAssignVAPIAssistant**:
   - `test_assign_success` - Returns success with data
   - `test_assign_with_server_url` - Includes serverUrl for client routing
   - `test_assign_failure` - Returns error on API failure

7. **TestProvisionPhoneForTenant**:
   - `test_provision_full_workflow_success` - Complete flow: search -> buy -> import
   - `test_provision_no_numbers_available` - Fails at search step
   - `test_provision_purchase_fails` - Fails at purchase step
   - `test_provision_import_fails` - Fails at import step (number purchased but not in VAPI)
   - `test_provision_tracks_steps` - Steps list shows completed steps

8. **TestAddressManagement**:
   - `test_register_address_success` - Returns success with SID
   - `test_register_address_failure` - Returns error on API failure
   - `test_list_addresses_success` - Returns formatted address list
   - `test_list_addresses_empty` - Returns empty list when no addresses
   - `test_get_address_for_country` - Finds address by country code
   - `test_get_address_for_country_not_found` - Returns None when no match

9. **TestBuyWithAddress**:
   - `test_buy_with_address_success` - Includes AddressSid in purchase
   - `test_buy_with_address_failure` - Returns error on API failure

10. **TestClientPhoneOnboarding**:
    - `test_register_client_address` - Delegates to provisioner
    - `test_get_number_options` - Returns formatted options for UI
    - `test_complete_phone_setup` - Delegates to provision_with_client_selection

11. **TestHelperFunctions**:
    - `test_provision_tenant_phone_success` - Quick helper works with env vars
    - `test_provision_tenant_phone_missing_credentials` - Returns error without creds
    - `test_format_phone_display_za` - Formats South African numbers
    - `test_format_phone_display_us` - Formats US/Canada numbers
    - `test_format_phone_display_other` - Returns number as-is for other countries

**Mocking strategy:**
- Patch `requests.get`, `requests.post`, `requests.patch` at module level
- Use `@responses` library or manual mocking with side_effect
- Configure responses based on URL patterns

Target: 40+ tests covering all major code paths, achieving 50%+ coverage
  </action>
  <verify>
```bash
cd "C:\Users\jerry\Documents\multitenant-ai-platform-lite" && python -m pytest tests/test_twilio_vapi_provisioner.py -v --tb=short 2>&1 | head -100
```
  </verify>
  <done>All Twilio VAPI provisioner tests pass; coverage reaches 50%+</done>
</task>

<task type="auto">
  <name>Task 3: Verify coverage and ensure 50%+ target</name>
  <files>tests/test_twilio_vapi_provisioner.py</files>
  <action>
Run coverage report specifically for twilio_vapi_provisioner.py:

1. Run pytest with coverage on just the provisioner tests
2. Check coverage percentage for src/tools/twilio_vapi_provisioner.py
3. If below 50%, identify uncovered lines and add targeted tests:
   - Test get_pricing method
   - Test get_available_numbers_for_client formatting
   - Test provision_with_client_selection with and without address_sid
   - Test error paths in provision workflow

Key areas to ensure coverage:
- All HTTP methods (GET, POST, PATCH)
- All response status codes (200, 201, 400, etc.)
- Exception handling paths
- Country code mapping edge cases

Add any additional tests needed to cross the 50% threshold.
  </action>
  <verify>
```bash
cd "C:\Users\jerry\Documents\multitenant-ai-platform-lite" && python -m pytest tests/test_twilio_vapi_provisioner.py --cov=src/tools/twilio_vapi_provisioner --cov-report=term-missing 2>&1 | tail -30
```
  </verify>
  <done>Coverage report shows src/tools/twilio_vapi_provisioner.py at 50%+ coverage</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `python -c "from tests.fixtures.twilio_vapi_fixtures import *"` imports without error
2. `pytest tests/test_twilio_vapi_provisioner.py -v` shows 40+ tests passing
3. Coverage report shows twilio_vapi_provisioner.py at 50%+
</verification>

<success_criteria>
- Twilio/VAPI mock fixtures module created with documented classes
- Provisioner tests achieve 50%+ coverage (from 0%)
- Full provisioning workflow tested (search -> buy -> import -> assign)
- Address management for regulatory compliance tested
- All tests pass without making real API calls
</success_criteria>

<output>
After completion, create `.planning/phases/14-ai-agent-tests/14-03-SUMMARY.md`
</output>
