---
phase: 15-coverage-finalization
plan: 03
type: execute
wave: 2
depends_on: ["15-01", "15-02"]
files_modified:
  - pyproject.toml
  - .github/workflows/ci.yml
autonomous: true

must_haves:
  truths:
    - "CI pipeline enforces 70% coverage threshold"
    - "pyproject.toml coverage threshold updated to 70"
    - "Overall coverage reaches 70% target"
  artifacts:
    - path: "pyproject.toml"
      provides: "Coverage threshold configuration"
      contains: "fail_under = 70"
    - path: ".github/workflows/ci.yml"
      provides: "CI coverage enforcement"
      contains: "--cov-fail-under=70"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "pyproject.toml"
      via: "pytest coverage configuration"
      pattern: "fail_under.*70"
---

<objective>
Update CI pipeline and pyproject.toml to enforce 70% coverage threshold after testing improvements.

Purpose: Phase 14 achieved 54.5% coverage. Plans 15-01 and 15-02 add tests for RAG tool, FAISS service, and admin knowledge routes. This plan updates the coverage threshold to 70% once the gap is closed.

Output: Coverage threshold updated from 45% to 70% in both pyproject.toml and ci.yml, with verification that overall coverage meets the new target.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@pyproject.toml (current threshold: 45)
@.github/workflows/ci.yml (current threshold: 45)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify coverage reaches 70% threshold</name>
  <files></files>
  <action>
Run full test suite with coverage to verify overall coverage reaches 70%.

1. Run pytest with coverage on entire codebase:
```bash
cd "C:\Users\jerry\Documents\multitenant-ai-platform-lite" && python -m pytest tests/ --cov=src --cov=config --cov-report=term-missing --cov-report=html 2>&1 | tail -100
```

2. Check the overall coverage percentage in the output.

3. If coverage is below 70%:
   - Identify the top 3-5 modules with lowest coverage that are feasible to test
   - Check which modules have significant uncovered lines
   - Note the gap remaining (e.g., "at 65%, need 5% more")

4. If coverage is at or above 70%:
   - Proceed to Task 2 (update thresholds)
   - Note the exact coverage achieved for documentation

**Key modules to check:**
- src/tools/rag_tool.py (target: 50%+)
- src/services/faiss_helpdesk_service.py (target: 50%+)
- src/api/admin_knowledge_routes.py (target: 50%+, up from 17.9%)

If coverage is significantly below 70% (e.g., <65%), consider what additional quick wins might close the gap before proceeding.
  </action>
  <verify>
```bash
cd "C:\Users\jerry\Documents\multitenant-ai-platform-lite" && python -m pytest tests/ --cov=src --cov=config --cov-report=term 2>&1 | grep -E "^(TOTAL|Name|src/|config/)" | tail -20
```
  </verify>
  <done>Coverage percentage verified; either at 70%+ or gap identified with remediation plan</done>
</task>

<task type="auto">
  <name>Task 2: Update pyproject.toml coverage threshold</name>
  <files>pyproject.toml</files>
  <action>
Update the coverage threshold in pyproject.toml from 45 to 70.

**Changes to make:**

1. Find the `[tool.coverage.report]` section
2. Update `fail_under = 45` to `fail_under = 70`
3. Update the comment to reflect v4.0 milestone completion

**Before:**
```toml
[tool.coverage.report]
# ... exclude_lines ...
# Coverage threshold:
# - v3.0: 45% (achieved 2026-01-21, up from 27%)
# - v4.0 target: 70% (requires extensive external API mocking)
# Prevents regression below current coverage level
fail_under = 45
```

**After:**
```toml
[tool.coverage.report]
# ... exclude_lines ...
# Coverage threshold:
# - v3.0: 45% (achieved 2026-01-21, up from 27%)
# - v4.0: 70% (achieved 2026-01-22, with comprehensive mocking)
# Prevents regression below current coverage level
fail_under = 70
```

Note: If Task 1 showed coverage below 70%, adjust the threshold to the actual achieved coverage (e.g., 65% if that's where we are), and note this in the comment.
  </action>
  <verify>
```bash
grep -A5 "fail_under" "C:/Users/jerry/Documents/multitenant-ai-platform-lite/pyproject.toml"
```
  </verify>
  <done>pyproject.toml updated with new coverage threshold</done>
</task>

<task type="auto">
  <name>Task 3: Update CI workflow coverage threshold</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Update the coverage threshold in GitHub Actions CI workflow to match pyproject.toml.

**Changes to make:**

1. Find the pytest command with `--cov-fail-under=45`
2. Update to `--cov-fail-under=70`
3. Update the comment to reflect v4.0 milestone completion

**Before:**
```yaml
      - name: Run tests with coverage
        run: |
          # v3.0: 45% threshold (achieved 2026-01-21)
          # v4.0 target: 70% (requires extensive external API mocking)
          pytest tests/ -v --tb=short --cov=src --cov=main --cov=config --cov-report=term-missing --cov-fail-under=45
```

**After:**
```yaml
      - name: Run tests with coverage
        run: |
          # v4.0: 70% threshold (achieved 2026-01-22)
          # Enforces comprehensive test coverage with external API mocking
          pytest tests/ -v --tb=short --cov=src --cov=main --cov=config --cov-report=term-missing --cov-fail-under=70
```

Note: If Task 1 showed coverage below 70%, use the actual achieved threshold.
  </action>
  <verify>
```bash
grep -A3 "cov-fail-under" "C:/Users/jerry/Documents/multitenant-ai-platform-lite/.github/workflows/ci.yml"
```
  </verify>
  <done>ci.yml updated with new coverage threshold matching pyproject.toml</done>
</task>

<task type="auto">
  <name>Task 4: Final verification and test run</name>
  <files></files>
  <action>
Run final test suite to confirm everything passes with the new threshold.

1. Run full test suite with new threshold:
```bash
cd "C:\Users\jerry\Documents\multitenant-ai-platform-lite" && python -m pytest tests/ -v --tb=short --cov=src --cov=config --cov-fail-under=70 2>&1 | tail -50
```

2. Verify:
   - All tests pass
   - Coverage meets or exceeds 70%
   - No new test failures introduced

3. If tests fail due to coverage threshold:
   - Lower threshold to actual coverage + 1%
   - Update both pyproject.toml and ci.yml
   - Re-run verification

4. Generate final coverage report for documentation:
```bash
cd "C:\Users\jerry\Documents\multitenant-ai-platform-lite" && python -m pytest tests/ --cov=src --cov=config --cov-report=term 2>&1 | grep "TOTAL"
```

5. Document the final coverage percentage achieved for the SUMMARY.
  </action>
  <verify>
```bash
cd "C:\Users\jerry\Documents\multitenant-ai-platform-lite" && python -m pytest tests/ --cov=src --cov=config --cov-fail-under=70 2>&1 | tail -10
```
  </verify>
  <done>Full test suite passes with 70% coverage threshold enforced</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `grep "fail_under" pyproject.toml` shows 70
2. `grep "cov-fail-under" .github/workflows/ci.yml` shows 70
3. `pytest tests/ --cov-fail-under=70` passes
4. Coverage report shows 70%+ overall
</verification>

<success_criteria>
- pyproject.toml updated: fail_under = 70
- ci.yml updated: --cov-fail-under=70
- Full test suite passes with new threshold
- Overall coverage reaches 70% (v4.0 milestone target)
- CI will now enforce 70% threshold on all PRs
</success_criteria>

<output>
After completion, create `.planning/phases/15-coverage-finalization/15-03-SUMMARY.md`
</output>
