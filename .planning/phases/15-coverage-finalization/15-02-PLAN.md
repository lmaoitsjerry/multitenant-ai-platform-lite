---
phase: 15-coverage-finalization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/test_admin_knowledge_routes.py
autonomous: true

must_haves:
  truths:
    - "Admin knowledge routes require admin authentication"
    - "Document CRUD operations can be tested with mocked GCS"
    - "File upload handling can be tested with multipart mocks"
    - "Knowledge base stats endpoint returns expected structure"
  artifacts:
    - path: "tests/test_admin_knowledge_routes.py"
      provides: "Admin knowledge routes test coverage"
      min_lines: 400
  key_links:
    - from: "tests/test_admin_knowledge_routes.py"
      to: "src/api/admin_knowledge_routes.py"
      via: "TestClient and mocked GCS"
      pattern: "admin_knowledge_router"
---

<objective>
Create comprehensive tests for admin knowledge routes to increase coverage from 17.9% to 50%+.

Purpose: The admin_knowledge_routes.py handles document management in the RAG knowledge base via GCS and FAISS. Currently at 17.9% coverage - needs tests for document CRUD, file upload, cache operations, and stats endpoints.

Output: Admin knowledge routes test file achieving 50%+ coverage (up from 17.9%)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@tests/test_knowledge_routes.py (pattern reference - existing knowledge tests)
@tests/test_admin_routes.py (pattern reference - admin auth testing)
@src/api/admin_knowledge_routes.py (module to test - 17.9% coverage)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin knowledge routes tests - Auth and Document List</name>
  <files>tests/test_admin_knowledge_routes.py</files>
  <action>
Create test file for `src/api/admin_knowledge_routes.py` with auth verification and document listing tests.

**Test classes to implement:**

1. **TestAdminKnowledgeAuth**:
   - `test_list_documents_requires_admin_token` - Returns 401/503 without valid admin token
   - `test_create_document_requires_admin_token` - POST requires admin auth
   - `test_get_document_requires_admin_token` - GET /{doc_id} requires admin auth
   - `test_update_document_requires_admin_token` - PUT requires admin auth
   - `test_delete_document_requires_admin_token` - DELETE requires admin auth
   - `test_rebuild_index_requires_admin_token` - POST /rebuild-index requires admin auth
   - `test_stats_requires_admin_token` - GET /stats requires admin auth

2. **TestListDocumentsEndpoint**:
   - `test_list_documents_returns_list` - Returns paginated document list
   - `test_list_documents_with_category_filter` - Filters by category
   - `test_list_documents_with_tenant_filter` - Filters by tenant_id
   - `test_list_documents_global_filter` - Filters for global (no tenant) docs
   - `test_list_documents_pagination_limit` - Respects limit parameter
   - `test_list_documents_pagination_offset` - Respects offset parameter
   - `test_list_documents_max_limit_200` - Limit capped at 200
   - `test_list_documents_empty_result` - Returns empty list when no docs
   - `test_list_documents_response_structure` - Has success, data, count, total

3. **TestCacheFunctions**:
   - `test_get_cached_returns_none_on_miss` - Cache miss returns None
   - `test_set_cached_stores_value` - Cache stores and retrieves value
   - `test_get_cached_returns_value_before_expiry` - Returns cached value if valid
   - `test_get_cached_returns_none_after_expiry` - Returns None when expired
   - `test_invalidate_cache_all` - Clears entire cache
   - `test_invalidate_cache_by_prefix` - Clears only matching keys

**Mocking strategy:**
- Set ADMIN_API_TOKEN env var via `patch.dict(os.environ, {'ADMIN_API_TOKEN': 'test-token'})`
- Use TestClient with X-Admin-Token header for authenticated requests
- Mock GCS client at `src.api.admin_knowledge_routes.get_gcs_client`
- Mock document metadata loading functions

Include test fixtures for:
- Mock admin token authentication
- Sample document metadata
- Mock GCS bucket responses
  </action>
  <verify>
```bash
cd "C:\Users\jerry\Documents\multitenant-ai-platform-lite" && python -m pytest tests/test_admin_knowledge_routes.py::TestAdminKnowledgeAuth -v --tb=short 2>&1
```
  </verify>
  <done>Auth and list document tests pass; test file structure established</done>
</task>

<task type="auto">
  <name>Task 2: Add document CRUD and GCS operation tests</name>
  <files>tests/test_admin_knowledge_routes.py</files>
  <action>
Extend test file with document CRUD and GCS helper function tests.

**Test classes to add:**

4. **TestCreateDocumentEndpoint**:
   - `test_create_document_success` - Creates document with valid request
   - `test_create_document_returns_doc_with_id` - Response includes generated doc_id
   - `test_create_document_sets_timestamps` - Sets created_at/updated_at
   - `test_create_document_default_category` - Uses "general" if not specified
   - `test_create_document_default_visibility` - Uses "public" if not specified
   - `test_create_document_with_tenant_id` - Stores tenant_id when provided
   - `test_create_document_validation_title_required` - Validates title required
   - `test_create_document_validation_content_required` - Validates content required
   - `test_create_document_validation_title_max_length` - Title max 200 chars
   - `test_create_document_invalidates_cache` - Clears documents cache

5. **TestGetDocumentEndpoint**:
   - `test_get_document_success` - Returns document with content
   - `test_get_document_not_found` - Returns 404 for unknown doc_id
   - `test_get_document_loads_content_from_gcs` - Fetches content from GCS
   - `test_get_document_falls_back_to_local` - Uses local file if GCS fails
   - `test_get_document_response_structure` - Has success and data fields

6. **TestUpdateDocumentEndpoint**:
   - `test_update_document_success` - Updates document fields
   - `test_update_document_not_found` - Returns 404 for unknown doc_id
   - `test_update_document_partial` - Can update single field
   - `test_update_document_title` - Updates title correctly
   - `test_update_document_category` - Updates category correctly
   - `test_update_document_content_saves_to_gcs` - Content change saves to GCS
   - `test_update_document_marks_unindexed` - Sets indexed=False on content change
   - `test_update_document_updates_timestamp` - Updates updated_at field
   - `test_update_document_invalidates_cache` - Clears documents cache

7. **TestDeleteDocumentEndpoint**:
   - `test_delete_document_success` - Deletes document from GCS and local
   - `test_delete_document_not_found` - Returns 404 for unknown doc_id
   - `test_delete_document_returns_deleted_doc` - Response includes deleted doc data
   - `test_delete_document_invalidates_cache` - Clears documents cache

8. **TestGCSHelperFunctions**:
   - `test_get_gcs_client_success` - Returns storage client when available
   - `test_get_gcs_client_failure` - Returns None when GCS unavailable
   - `test_get_gcs_bucket_success` - Returns bucket object
   - `test_get_gcs_bucket_failure` - Returns None on error
   - `test_list_gcs_documents` - Lists documents from GCS bucket
   - `test_list_gcs_documents_falls_back_to_local` - Uses local on GCS failure
   - `test_get_gcs_document_content_txt` - Gets .txt file content
   - `test_get_gcs_document_content_md` - Gets .md file content
   - `test_save_gcs_document_success` - Uploads document to GCS
   - `test_save_gcs_document_falls_back_to_local` - Uses local on GCS failure
   - `test_delete_gcs_document_success` - Deletes from GCS
   - `test_get_gcs_bucket_stats` - Returns bucket statistics

**Mocking strategy for GCS:**
- Create MockGCSBlob with exists(), download_as_text(), upload_from_string(), delete()
- Create MockGCSBucket with blob(), list_blobs()
- Patch google.cloud.storage.Client
- Use tmp_path fixture for local storage fallback testing
  </action>
  <verify>
```bash
cd "C:\Users\jerry\Documents\multitenant-ai-platform-lite" && python -m pytest tests/test_admin_knowledge_routes.py::TestCreateDocumentEndpoint tests/test_admin_knowledge_routes.py::TestGetDocumentEndpoint tests/test_admin_knowledge_routes.py::TestUpdateDocumentEndpoint tests/test_admin_knowledge_routes.py::TestDeleteDocumentEndpoint -v --tb=short 2>&1 | head -60
```
  </verify>
  <done>Document CRUD tests pass; GCS helper tests implemented</done>
</task>

<task type="auto">
  <name>Task 3: Add stats, index rebuild, and Pydantic model tests</name>
  <files>tests/test_admin_knowledge_routes.py</files>
  <action>
Complete test file with stats, index rebuild, local storage, and Pydantic model tests.

**Test classes to add:**

9. **TestRebuildIndexEndpoint**:
   - `test_rebuild_index_success` - Returns indexed count
   - `test_rebuild_index_marks_documents_indexed` - Sets indexed=True on all docs
   - `test_rebuild_index_updates_timestamps` - Updates document timestamps
   - `test_rebuild_index_response_structure` - Has success, message, documents_indexed

10. **TestStatsEndpoint**:
    - `test_stats_returns_totals` - Returns total_documents and total_chunks
    - `test_stats_returns_category_counts` - Returns category breakdown
    - `test_stats_returns_global_vs_tenant` - Separates global and tenant docs
    - `test_stats_returns_index_info` - Returns index size and last_indexed
    - `test_stats_returns_storage_info` - Returns storage type (gcs/local)
    - `test_stats_includes_faiss_status` - Includes faiss_index info
    - `test_stats_handles_faiss_error` - Handles FAISS service errors gracefully

11. **TestLocalStorageFallback**:
    - `test_load_documents_metadata_local_success` - Loads from metadata.json
    - `test_load_documents_metadata_local_missing` - Returns empty if file missing
    - `test_save_documents_metadata_local` - Saves to metadata.json
    - `test_save_document_local` - Saves document file and updates metadata
    - `test_delete_document_local` - Deletes file and removes from metadata
    - `test_get_metadata_path` - Returns correct path

12. **TestUtilityFunctions**:
    - `test_generate_document_id` - Generates unique doc_xxx format IDs
    - `test_get_index_stats_no_index` - Returns zeros when no index exists
    - `test_get_index_stats_with_files` - Calculates size and last_indexed
    - `test_load_documents_metadata_uses_cache` - Uses cached results
    - `test_load_documents_metadata_cache_miss` - Fetches from GCS on miss

13. **TestPydanticModels**:
    - `test_knowledge_document_model` - All fields present
    - `test_knowledge_document_defaults` - Default values correct
    - `test_document_create_request_validation` - Validates required fields
    - `test_document_create_request_title_min_length` - Title >= 1 char
    - `test_document_create_request_content_min_length` - Content >= 1 char
    - `test_document_update_request_optional_fields` - All fields optional
    - `test_knowledge_stats_model` - Stats model has all fields

14. **TestRouterRegistration**:
    - `test_admin_knowledge_router_exists` - Router is defined
    - `test_admin_knowledge_router_prefix` - Has correct prefix
    - `test_include_admin_knowledge_router_function` - Helper function exists

**Verification coverage target:**
Run final coverage check to ensure 50%+ on admin_knowledge_routes.py

Add any missing tests to cross the threshold:
- Look for error handling paths not covered
- Look for edge cases in GCS operations
- Look for conditional branches not hit
  </action>
  <verify>
```bash
cd "C:\Users\jerry\Documents\multitenant-ai-platform-lite" && python -m pytest tests/test_admin_knowledge_routes.py --cov=src/api/admin_knowledge_routes --cov-report=term-missing 2>&1 | tail -40
```
  </verify>
  <done>All admin knowledge routes tests pass; coverage reaches 50%+ (up from 17.9%)</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `pytest tests/test_admin_knowledge_routes.py -v` shows 50+ tests passing
2. Coverage report shows admin_knowledge_routes.py at 50%+ (up from 17.9%)
3. All CRUD operations, GCS helpers, and stats endpoints tested
</verification>

<success_criteria>
- Admin knowledge routes test file created with comprehensive coverage
- Coverage increases from 17.9% to 50%+
- Auth requirements verified for all endpoints
- Document CRUD operations fully tested
- GCS and local storage fallback paths covered
- All tests pass without making real GCS or admin API calls
</success_criteria>

<output>
After completion, create `.planning/phases/15-coverage-finalization/15-02-SUMMARY.md`
</output>
