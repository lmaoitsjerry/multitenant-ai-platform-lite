"""
PDF Generator - Multi-Tenant Version

Generates PDFs using WeasyPrint (preferred) or fpdf2 (fallback for Windows).
Each tenant's branding is applied to the generated PDFs.
"""

import logging
from typing import Dict, Any, Optional
from pathlib import Path

logger = logging.getLogger(__name__)

# Try WeasyPrint first
WEASYPRINT_AVAILABLE = False
try:
    from weasyprint import HTML, CSS
    # Test if GTK3 is available by trying to import
    HTML(string="<html></html>")
    WEASYPRINT_AVAILABLE = True
    logger.info("WeasyPrint with GTK3 is available")
except Exception as e:
    logger.warning(f"WeasyPrint not available: {e}")

# Fallback to fpdf2
FPDF_AVAILABLE = False
try:
    from fpdf import FPDF
    FPDF_AVAILABLE = True
    logger.info("fpdf2 is available as fallback")
except ImportError:
    logger.warning("fpdf2 not installed. Run: pip install fpdf2")


class PDFGenerator:
    """Generate PDFs with client branding"""

    def __init__(self, config, template_renderer=None):
        """
        Initialize PDF generator
        
        Args:
            config: ClientConfig instance
            template_renderer: Optional TemplateRenderer instance
        """
        self.config = config
        self.template_renderer = template_renderer
        
        # Branding
        self.company_name = getattr(config, 'company_name', 'Travel Agency')
        self.primary_color = getattr(config, 'primary_color', '#2E86AB')
        self.secondary_color = getattr(config, 'secondary_color', '#A23B72')
        self.logo_url = getattr(config, 'logo_url', None)
        self.currency = getattr(config, 'currency', 'ZAR')
        
        logger.info(f"PDF generator initialized for {config.client_id}")

    def generate_quote_pdf(
        self,
        quote_data: Dict[str, Any],
        hotels: list,
        customer_data: Dict[str, Any]
    ) -> bytes:
        """
        Generate a quote PDF
        
        Args:
            quote_data: Quote information (id, dates, etc.)
            hotels: List of hotel options with pricing
            customer_data: Customer information
            
        Returns:
            PDF as bytes
        """
        if WEASYPRINT_AVAILABLE and self.template_renderer:
            return self._generate_with_weasyprint(quote_data, hotels, customer_data)
        elif FPDF_AVAILABLE:
            return self._generate_with_fpdf(quote_data, hotels, customer_data)
        else:
            logger.error("No PDF library available!")
            return b""

    def _generate_with_weasyprint(
        self,
        quote_data: Dict[str, Any],
        hotels: list,
        customer_data: Dict[str, Any]
    ) -> bytes:
        """Generate PDF using WeasyPrint (HTML/CSS)"""
        try:
            context = {
                'company_name': self.company_name,
                'primary_color': self.primary_color,
                'secondary_color': self.secondary_color,
                'logo_url': self.logo_url,
                'currency': self.currency,
                'quote': quote_data,
                'hotels': hotels,
                'customer': customer_data
            }
            
            html_content = self.template_renderer.render_template('pdf/quote.html', context)
            pdf_bytes = HTML(string=html_content).write_pdf()
            
            logger.info(f"✅ PDF generated with WeasyPrint: {len(pdf_bytes)} bytes")
            return pdf_bytes
            
        except Exception as e:
            logger.error(f"WeasyPrint PDF generation failed: {e}")
            # Fall back to fpdf
            if FPDF_AVAILABLE:
                return self._generate_with_fpdf(quote_data, hotels, customer_data)
            return b""

    def _generate_with_fpdf(
        self,
        quote_data: Dict[str, Any],
        hotels: list,
        customer_data: Dict[str, Any]
    ) -> bytes:
        """Generate PDF using fpdf2 (pure Python)"""
        try:
            pdf = FPDF()
            pdf.set_auto_page_break(auto=True, margin=15)
            pdf.add_page()
            
            # Convert hex color to RGB
            def hex_to_rgb(hex_color):
                hex_color = hex_color.lstrip('#')
                return tuple(int(hex_color[i:i+2], 16) for i in (0, 2, 4))
            
            primary_rgb = hex_to_rgb(self.primary_color)
            
            # Header
            pdf.set_fill_color(*primary_rgb)
            pdf.rect(0, 0, 210, 40, 'F')
            
            pdf.set_text_color(255, 255, 255)
            pdf.set_font('Helvetica', 'B', 24)
            pdf.set_xy(10, 12)
            pdf.cell(190, 10, self.company_name, align='C')
            
            pdf.set_font('Helvetica', '', 12)
            pdf.set_xy(10, 25)
            pdf.cell(190, 10, 'Travel Quote', align='C')
            
            # Reset text color
            pdf.set_text_color(0, 0, 0)
            
            # Quote details
            pdf.set_xy(10, 50)
            pdf.set_font('Helvetica', 'B', 14)
            pdf.cell(190, 10, f"Quote: {quote_data.get('quote_id', 'N/A')}")
            
            pdf.set_font('Helvetica', '', 11)
            pdf.set_xy(10, 62)
            pdf.cell(190, 7, f"Customer: {customer_data.get('name', 'N/A')}")
            pdf.set_xy(10, 69)
            pdf.cell(190, 7, f"Email: {customer_data.get('email', 'N/A')}")
            pdf.set_xy(10, 76)
            pdf.cell(190, 7, f"Destination: {quote_data.get('destination', 'N/A')}")
            pdf.set_xy(10, 83)
            pdf.cell(190, 7, f"Dates: {quote_data.get('check_in_date', 'N/A')} to {quote_data.get('check_out_date', 'N/A')}")
            pdf.set_xy(10, 90)
            pdf.cell(190, 7, f"Guests: {quote_data.get('adults', 0)} Adults, {quote_data.get('children', 0)} Children")
            
            # Hotels section
            pdf.set_xy(10, 105)
            pdf.set_font('Helvetica', 'B', 14)
            pdf.set_text_color(*primary_rgb)
            pdf.cell(190, 10, 'Accommodation Options')
            pdf.set_text_color(0, 0, 0)
            
            y_position = 118
            
            for i, hotel in enumerate(hotels, 1):
                if y_position > 250:
                    pdf.add_page()
                    y_position = 20
                
                # Hotel box
                pdf.set_fill_color(248, 249, 250)
                pdf.rect(10, y_position - 3, 190, 45, 'F')
                
                # Hotel name
                pdf.set_font('Helvetica', 'B', 12)
                pdf.set_xy(15, y_position)
                hotel_name = hotel.get('hotel_name', 'Hotel')
                rating = hotel.get('hotel_rating', '')
                pdf.cell(180, 7, f"Option {i}: {hotel_name} ({rating})")
                
                # Details
                pdf.set_font('Helvetica', '', 10)
                pdf.set_xy(15, y_position + 8)
                pdf.cell(90, 6, f"Room: {hotel.get('room_type', 'Standard')}")
                pdf.set_xy(105, y_position + 8)
                pdf.cell(90, 6, f"Meal Plan: {hotel.get('meal_plan', 'N/A')}")
                
                # Pricing
                pdf.set_xy(15, y_position + 16)
                total_price = hotel.get('total_price', 0)
                pdf.cell(90, 6, f"Per Person: {self.currency} {hotel.get('price_per_person', 0):,.0f}")
                
                pdf.set_font('Helvetica', 'B', 11)
                pdf.set_xy(15, y_position + 24)
                pdf.set_text_color(*primary_rgb)
                pdf.cell(90, 6, f"Total: {self.currency} {total_price:,.0f}")
                pdf.set_text_color(0, 0, 0)
                
                # Transfers
                pdf.set_font('Helvetica', '', 9)
                pdf.set_xy(15, y_position + 32)
                transfers = hotel.get('transfers_total', 0)
                pdf.cell(180, 5, f"(Includes transfers: {self.currency} {transfers:,.0f})")
                
                y_position += 52
            
            # Footer
            pdf.set_y(-30)
            pdf.set_font('Helvetica', 'I', 9)
            pdf.set_text_color(128, 128, 128)
            pdf.cell(0, 10, f'Quote generated by {self.company_name}', align='C')
            pdf.set_y(-22)
            pdf.cell(0, 10, 'Prices subject to availability. Valid for 7 days.', align='C')
            
            # Output
            pdf_bytes = pdf.output()
            
            logger.info(f"✅ PDF generated with fpdf2: {len(pdf_bytes)} bytes")
            return bytes(pdf_bytes)
            
        except Exception as e:
            logger.error(f"fpdf2 PDF generation failed: {e}")
            import traceback
            traceback.print_exc()
            return b""

    def generate_invoice_pdf(
        self,
        invoice_data: Dict[str, Any],
        items: list,
        customer_data: Dict[str, Any]
    ) -> bytes:
        """
        Generate an invoice PDF
        
        Args:
            invoice_data: Invoice information
            items: Line items
            customer_data: Customer information
            
        Returns:
            PDF as bytes
        """
        if FPDF_AVAILABLE:
            return self._generate_invoice_fpdf(invoice_data, items, customer_data)
        return b""

    def _generate_invoice_fpdf(
        self,
        invoice_data: Dict[str, Any],
        items: list,
        customer_data: Dict[str, Any]
    ) -> bytes:
        """Generate invoice PDF using fpdf2"""
        try:
            pdf = FPDF()
            pdf.set_auto_page_break(auto=True, margin=15)
            pdf.add_page()
            
            def hex_to_rgb(hex_color):
                hex_color = hex_color.lstrip('#')
                return tuple(int(hex_color[i:i+2], 16) for i in (0, 2, 4))
            
            primary_rgb = hex_to_rgb(self.primary_color)
            
            # Header
            pdf.set_fill_color(*primary_rgb)
            pdf.rect(0, 0, 210, 35, 'F')
            
            pdf.set_text_color(255, 255, 255)
            pdf.set_font('Helvetica', 'B', 20)
            pdf.set_xy(10, 10)
            pdf.cell(190, 10, 'INVOICE', align='C')
            
            pdf.set_font('Helvetica', '', 12)
            pdf.set_xy(10, 22)
            pdf.cell(190, 8, self.company_name, align='C')
            
            pdf.set_text_color(0, 0, 0)
            
            # Invoice details
            pdf.set_xy(10, 45)
            pdf.set_font('Helvetica', 'B', 12)
            pdf.cell(95, 8, f"Invoice #: {invoice_data.get('invoice_id', 'N/A')}")
            pdf.cell(95, 8, f"Date: {invoice_data.get('created_at', 'N/A')[:10]}", align='R')
            
            # Customer details
            pdf.set_xy(10, 60)
            pdf.set_font('Helvetica', 'B', 11)
            pdf.cell(190, 7, 'Bill To:')
            pdf.set_font('Helvetica', '', 10)
            pdf.set_xy(10, 68)
            pdf.cell(190, 6, customer_data.get('name', 'N/A'))
            pdf.set_xy(10, 74)
            pdf.cell(190, 6, customer_data.get('email', 'N/A'))
            
            # Items table
            y = 90
            pdf.set_xy(10, y)
            pdf.set_font('Helvetica', 'B', 10)
            pdf.set_fill_color(240, 240, 240)
            pdf.cell(100, 8, 'Description', border=1, fill=True)
            pdf.cell(45, 8, 'Quantity', border=1, fill=True, align='C')
            pdf.cell(45, 8, 'Amount', border=1, fill=True, align='R')
            
            y += 8
            pdf.set_font('Helvetica', '', 10)
            total = 0
            for item in items:
                pdf.set_xy(10, y)
                pdf.cell(100, 7, str(item.get('description', '')), border=1)
                pdf.cell(45, 7, str(item.get('quantity', 1)), border=1, align='C')
                amount = item.get('amount', 0)
                total += amount
                pdf.cell(45, 7, f"{self.currency} {amount:,.0f}", border=1, align='R')
                y += 7
            
            # Total
            pdf.set_xy(10, y + 5)
            pdf.set_font('Helvetica', 'B', 12)
            pdf.cell(145, 10, 'Total:', align='R')
            pdf.set_text_color(*primary_rgb)
            pdf.cell(45, 10, f"{self.currency} {total:,.0f}", align='R')
            
            pdf_bytes = pdf.output()
            logger.info(f"✅ Invoice PDF generated: {len(pdf_bytes)} bytes")
            return bytes(pdf_bytes)
            
        except Exception as e:
            logger.error(f"Invoice PDF generation failed: {e}")
            return b""
